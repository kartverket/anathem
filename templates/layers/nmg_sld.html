<%include file="/functions/vector.html" />

var format = new OpenLayers.Format.SLD();

strTFS = new OpenLayers.Strategy.TFS({
  resFactor: 1, 
  ratio: 1, 
  mapBounds: mapBounds,
  format: new OpenLayers.Format.GeoJSON()
});

st2TFS = new OpenLayers.Strategy.TFS({
  resFactor: 1, 
  ratio: 1, 
  mapBounds: mapBounds, 
  format: new OpenLayers.Format.GeoJSON()
});

prtTFS = new OpenLayers.Protocol.TFS({ 
  url: "/stache/kd_nmg",
  last: false,
  format: new OpenLayers.Format.GeoJSON()
});

pr2TFS = new OpenLayers.Protocol.TFS({
  url: "/stache/kd_nmg_line",
  last: false,
  format: new OpenLayers.Format.GeoJSON()
}); 

nmgrLayer = new OpenLayers.Layer.Vector(
  "Norges maritime grenser",
  {
    shortid: "grenser.maritime",
    strategies: [strTFS],
    protocol:prtTFS,
    projection: mapProj,
    visibility: ${visible}
  }
);

nmgrLayer.setOpacity(0.8);

nmglLayer = new OpenLayers.Layer.Vector(
  "Maritime grenser (linje)",
  {
    shortid: "grenser.maritime.line",
    strategies: [st2TFS],
    protocol:pr2TFS,
    projection: mapProj,
    displayInLayerSwitcher: false,
    visibility: ${visible}
  }
);

map.events.on({
  "changelayer": function () { 
    nmglLayer.setVisibility(nmgrLayer.getVisibility()) 
  }
});

map.addLayers([nmgrLayer,nmglLayer]);

var featureTranslate = {
  'Sjoterritorium':'territorium', //rose
  'Tilstotende_sone':'Indre farvann', //blarose
  'Norges_okonomiske_sone':'konomiske sone', //darkblaa
  'Fiskevernsonen_ved_Svalbard':'sonen ved Svalbard', //midblaa
  'Fiskerisonen_ved_Jan_Mayen':'sonen ved Jan Mayen', //midblaa
  'Internasjonalt_farvann':'Smutt', //groenn

  'avgrensningslinje_for_sokkel':'avgrensningslinje', //groenn, dash
  'Sokkelgrense':'Yttergrense', //groenn, cont
  '200_nautiske_mil':'nautiske mil', //blaa, cont
  'Avtalt_avgrensningslinje':'---', //blaa, cont
  'Yttergrense_for_tilstotend_sone':'---', //blaa, tynn
  'Territorialgrense':'Territorialgrense', //blaa, tykk
  'Grunnlinje':'Grunnlinje' //blaa, tynn
}

function setLayerStyles() {
  styleMap = new OpenLayers.StyleMap({'default':new OpenLayers.Style()});

  for (var featureName in sld.namedLayers) {
    var styles = sld.namedLayers[featureName].userStyles, style;
    style = styles[0];
    /*styleMap.styles["default"].rules.push( 
      new OpenLayers.Rule({
          filter: new OpenLayers.Filter.Comparison({
            type: OpenLayers.Filter.Comparison.LIKE,
            property: "o",
            value: featureTranslate[featureName]
          }),
          symbolizer: style.rules[0].symbolizer
      })
    );*/
    styleMap.styles["default"].rules.push( 
      new OpenLayers.Rule({
          filter: new OpenLayers.Filter.Comparison({
            type: OpenLayers.Filter.Comparison.LIKE,
            property: "n",
            value: featureTranslate[featureName]
          }),
          symbolizer: style.rules[0].symbolizer
      })
    );
  }

  nmgrLayer.styleMap = styleMap;
  nmglLayer.styleMap = styleMap;
}

OpenLayers.Request.GET({
  url: "http://wms.geonorge.no/sld/NMG.xml",
  success: function (req) {
    sld = format.read(req.responseXML || req.responseText);
    setLayerStyles();
  } 
});

nmgr_info = function (feature) {
  alert(feature.attributes['n'] + "\n" + feature.attributes['o']);
};

NK.functions.vector.addVectorControls(map, nmgrLayer, nmgr_info);
//NK.functions.vector.addVectorControls(map, nmglLayer, nmgr_info);

