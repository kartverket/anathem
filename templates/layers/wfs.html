<%include file="/functions/vector.html"/>

% if popup:
  <%include file="/functions/popup.html"/>
% endif

% if cluster:
  <%include file="/strategies/cluster.html"/>
% endif


% if not 'layerTypeWFS' in vars:

NK.addLayerType = NK.addLayerType || {};
NK.addLayerType.WFS = (function (M, MP) {
	var matrixIds,
    	i;

	return function (name, id, url, featureNS, featurePrefix, featureType, options) {

		var protocolParameters,
			protocol,
			layer,
			layerOptions;

		protocolParameters = {
			version: options.version || '1.1.0',
			url: '/ws/px.py?'+url,
			proxyUrl: '/ws/px.py?'+url,
			origUrl: url,
			featureNS: featureNS,
			featurePrefix: featurePrefix,
			featureType: featureType,
			outputFormat: options.outputFormat || 'text/xml; subtype=gml/3.2.1',
			readFormat: new OpenLayers.Format.GML.v3()
		};

                if (!!options.method && options.method=="GET") {
                  protocolParameters = {
                        url: '/ws/px.py?'+url,
                        origUrl: url,
			featureType: featureType,
                        params: {
                          request: "GetFeature",
                          service: "wfs",
                          typename: featureType, 
                          srsName: options.epsg || "EPSG:"+NK.baseProjection, 
                          version: options.version || '1.1.0'
                        },
                        format: new OpenLayers.Format.GML.v3({
                        })
                  };
		  protocol = new OpenLayers.Protocol.HTTP(protocolParameters);
                } else {
  		  protocol = new OpenLayers.Protocol.WFS(protocolParameters);
                }

		layerOptions = {
            strategies: [new OpenLayers.Strategy.BBOX()],
			shortid: id,
			protocol: protocol,
			projection: MP,
			displayInLayerSwitcher: (options && options.hideFromLayerSwitcher) ? 0 : 1,
			visibility: !!(options.visibility) ? 1 : 0
		};


		if (options.styleName && NK.styles && NK.styles[options.styleName]) {
			layerOptions.styleMap = NK.styles[options.styleName];
		}

		if (options.styleNameSLD && NK.styles && NK.styles.SLD && NK.styles.SLD[options.styleNameSLD]) {
			layerOptions.styleMap = NK.styles.SLD[options.styleNameSLD];
		}

	    if (options.cluster && NK.strategies.cluster) {
	      layerOptions.strategies.push(NK.strategies.cluster);
	    }

		layer = new OpenLayers.Layer.Vector(
			name,
			layerOptions
		);

	    if (options.cluster) {
	      	NK.styles.addClusteringRule(layer.styleMap);
	    }

		if (options && options.layerGroup) {
			layer = OpenLayers.Util.extend(layer, {'layerGroup': options.layerGroup});
		}

		if (options && options.visibility) {
			NK.defaultVisibleLayers = NK.defaultVisibleLayers || [];
			NK.defaultVisibleLayers.push(id);
		}

		M.addLayers([layer]);

	    if (options && options.popupConfig) {
	      NK.functions.popup.addConfiguredPopup(M, layer, options.popupConfig);
	    }

	    if (options.styleNameSLD && NK.styles && NK.styles.SLD && NK.styles.SLD[options.styleNameSLD]) {
	        NK.functions.setSLDStyleForLayer(options.styleNameSLD, layer);
	    }

	    //NK.functions.vector.addVectorHoverControls(M, layer, false);
            NK.functions.popup.addConfiguredPopup(M, layer, options.popupConfig);

            return layer;
	};

}(map, mapProj));

<% vars['layerTypeWFS']=True %>
% endif

% if name: 
## do nothing if name is not given - useful to just include the functions above

(function() {
	var options = {};

% if layerGroup:
	options.layerGroup = "${layerGroup}";	
% endif

% if visible:
	options.visible = ${visible};	
% endif

% if hidefromlayerswitcher:
	options.hideFromLayerSwitcher = "${hidefromlayerswitcher}";	
% endif

% if cluster:
	options.cluster = true;
% endif

% if styleName:
	options.styleName = '${styleName}';
% endif

% if styleNameSLD:
	options.styleNameSLD = '${styleNameSLD}';
% endif

% if popup:
  options.popupConfig = ${popup};
% endif

% if useToken:
  options.token = NK.gkToken;
% endif

% if version:
  options.version = '${version}';
% endif

% if visible:
  options.visibility = true;
% endif

  NK.addLayerType.WFS("${name}", "${id}", "${url}", "${namespace}", "${namespacePrefix}", "${featuretype}", options);	

}());

% endif
