(function () {
  var options = {};
  var wms = new OpenLayers.Layer.WMS(
    "${name}",
    "${url}",
    {
      % if usetoken:
      gkt: NK.gkToken,
      % endif
      % if useticket:
      ticket: NK.encTicket,
      % endif
% if usenibticket:
ticket: NK.nibTicket,
% endif
      layers: "${layers}",
      transparent: ${transparent},
  % if styles:
      styles: "${styles}",
  % endif
      format: '${format}'
    },
    {
      shortid: "${id}", 
      isBaseLayer: false,
      buffer: 0,
      ratio: 1,
      visibility: ${visible}, 
  % if singleTile:
      singleTile: true,
  % else:
      singleTile: false,
  % endif
  % if minZoom:
      minZoom: ${minZoom},
  % endif
      transitionEffect: 'resize',
      attribution: {
      'title':"${attribution}"
      },
      description: "${abstract}"
    }
  );

  % if layerGroup:
    wms = OpenLayers.Util.extend(wms, { layerGroup: '${layerGroup}' });
  % endif

  % if hidefromlayerswitcher:
    wms["displayInLayerSwitcher"] = false;
  % endif


  if (wms.params.GKT) {
    wms.params.gkt = wms.params.GKT;
    delete wms.params.GKT; 
  }

  % if useticket:
  if (wms.params.TICKET) {
    wms.params.ticket = wms.params.TICKET;
    delete wms.params.TICKET;
  }
  % endif
% if usenibticket:
if (wms.params.TICKET) {
wms.params.ticket = wms.params.TICKET;
delete wms.params.TICKET;
}
% endif

  % if linkedTo:
  wms.events.register("visibilitychanged", wms, function(arg) {
    map.getLayersBy("shortid","${linkedTo}")[0].setVisibility(wms.getVisibility());
  });
  %endif


  map.addLayers([wms]);
}());
