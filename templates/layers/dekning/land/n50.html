<%include file="/functions/vector.html" />
<%include file="/styles/dekning/land.html" />

(function (M, MP, P) {
  var layer,
      selectHandler,
      requestHandler;

  // dekningsoversikt - vector layer
  layer = new OpenLayers.Layer.Vector(
    "${name}",
    {
      shortid: "${id}", 
      styleMap: NK.styles.dekning.land, 
      visibility: ${visible},
      layerGroup: "${layerGroup}"
    }
  );

  M.addLayer(layer);

  requestHandler = function (request) {
    var geojson_format,
        features,
        feature, 
        key;

    geojson_format = new OpenLayers.Format.GeoJSON({
      'internalProjection': MP,
      'externalProjection': P['32633'] 
    });

    features = geojson_format.read(request.responseText);

    for (key in features) {
      feature = features[key];
      feature.attributes['nr'] = feature.fid;
    }

    layer.addFeatures(features);
  };

  OpenLayers.Request.GET({
    url: "${url}",
    callback: requestHandler
  });

  selectHandler = function(feature) {
    alert(feature.fid);
    postEvent({
      "event": "onSelect", 
      "element": "kartblad", 
      "type": "n50", 
      "id": feature.fid
    });
  };

  NK.functions.vector.addVectorControls(M, layer, selectHandler);

}(map, mapProj, proj));
