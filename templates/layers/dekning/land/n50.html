<%include file="/functions/vector.html" />
<%include file="/styles/dekning/land.html" />

(function (M, MP, P) {
  var layer,
      selectHandler,
      requestHandler;

  // dekningsoversikt - vector layer
  layer = new OpenLayers.Layer.Vector(
    "${name}",
    {
      shortid: "${id}", 
      styleMap: NK.styles.dekning.land, 
      visibility: ${visible},
      layerGroup: "${layerGroup}",
      preferredBackground: "${preferredBackground}"
    }
  );

  M.addLayer(layer);

  requestHandler = function (request) {
    var geojson_format,
        features,
        feature, 
        key;

    geojson_format = new OpenLayers.Format.GeoJSON({
      'internalProjection': MP,
      'externalProjection': P['32633'] 
    });

    features = geojson_format.read(request.responseText);

    for (key in features) {
      if (features.hasOwnProperty(key)) {
        feature = features[key];
        feature.attributes.nr = feature.fid;
      }
    }
    layer.addFeatures(features);
  };

  OpenLayers.Request.GET({
    url: "${url}",
    callback: requestHandler
  });

  selectHandler = function(feature) {
/*
    postEvent({
      "event": "onSelect", 
      "element": "kartblad", 
      "type": "n50", 
      "id": feature.fid
    });
*/
  };

  var selectControl;
  var onPopupClose = null;

  function onPopupClose(evt) {
      selectControl.unselect(NK.selectedCoverageMap);
      delete NK.selectedCoverageMap;
  }
  function generatePopupMarkup (feature) {
    var a  = feature.attributes;
      var markup = '<article>';
      markup += '<h1 class="h">' + a.n + '</h1>';
      markup += '<p>' + OpenLayers.Lang.translate('Map number') + ': ' + a.nr + '</p>';
      markup += '<div class="municipalities">' + OpenLayers.Lang.translate('Municipalities') + ': <span>' + a.k.split(',').join(',</span><span>') + '</span></div>';
      markup += '<p>' + OpenLayers.Lang.translate('Updated') + ': ' + a.u + '</p>';
      markup += '<p>' + OpenLayers.Lang.translate('EAN-number') + ': ' + a.e + '</p>';
      markup += '</article>';
      return markup;
  };
  var onFeatureUnselect = function (feature) {
      if (feature === NK.selectedCoverageMap) {
          NK.selectedCoverageMap = null;
      }
      if (feature.popup) {
        M.removePopup(feature.popup);
        feature.popup.destroy();
        feature.popup = null;
      }
  };

  function onFeatureSelect (feature) {
      NK = NK || {};
      if (NK.selectedCoverageMap ) {
          selectControl.unselect(NK.selectedCoverageMap);
      }
      NK.selectedCoverageMap = feature;

      var mousePosition = map.getLonLatFromPixel((map.getControlsByClass('OpenLayers.Control.MousePosition')[0]).lastXy);
      M.setCenter(mousePosition);
      var popup = new OpenLayers.Popup.FramedSideAnchored("nk-selected-coverage-map", 
                               mousePosition,
                               null,
                               generatePopupMarkup(feature),
                               null, true, onPopupClose);
      popup.autoSize = true;
      feature.popup = popup;
      M.addPopup(popup);
  }

  selectControl = new OpenLayers.Control.SelectFeature(layer, {
      select: onFeatureSelect, 
      unselect: onFeatureUnselect,
      click: true,
      autoActivate: true
  });

  M.addControl(selectControl);

/*  NK.functions.vector.addVectorControls(M, layer, selectHandler); */

}(map, mapProj, proj));
