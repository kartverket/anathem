var NK = NK || {};
NK.functions = NK.functions || {};

NK.functions.updateHistory = function (evt) {
  var center,
      zoom,
      i,
      layer,
      optchars,
      uid,
      search,
      searchInput;

  if (!!map) {
    center = map.getCenter();
    zoom   = map.getZoom();

    if (!!center && !!zoom) {
      uid = zoom + "/" + Math.round(center.lon) + "/" + Math.round(center.lat); 
      /* 1m precision ought to be enough for everyone --BG */

      if (!!NK.initLayers && !!map.layers) { 
        for (i in map.layers) {
          if (map.layers.hasOwnProperty(i)) {
            layer = map.layers[i];
            if (!layer.isBaseLayer) {
              if (layer.visibility) {
                if ($.inArray(layer.shortid, NK.initLayers) === -1) {
                  uid += "/+"+layer.shortid;
                }
              } else {
                if ($.inArray(layer.shortid, NK.initLayers) > -1) {
                  uid += "/-" + layer.shortid;
                }
              }
            }
          }
        }

        optchars="";

        if (typeof layer_sw !== 'undefined') {
          if ($.inArray(layer_sw,map.controls) === -1) {
            optchars += 'l';
          } else {
            if (!layer_sw.layersDiv.style.display) {
              optchars += 'L';
            }
          }
          if (typeof legend !== 'undefined') {
            if ($.inArray(legend,map.controls) === -1) {
              optchars += 'h';
            } else {
              if (!legend.wrapperDiv.style.display) {
                optchars += 'H';
              }
            }
            if (typeof nav !== 'undefined') {
              if (!nav.active) {
                optchars += 'n';
              }
            }
            if (typeof zoomCtrl !== 'undefined') {
              if ($.inArray(zoomCtrl,map.controls) === -1) {
                optchars += 'z';
              }
            }
            if (optchars.length > 0) {
              uid += "/w" + optchars;
            }
          }

          postEvent({
            "event": "onMoveMap",
            "x": center.lon, 
            "y": center.lat,
            "z": zoom
          });
        }
        
      }
    }
    searchInput = document.getElementById('searchInput');
    if (!!searchInput) {
      search = searchInput.value;
      if (history.pushState) {
        if (!!search) {
          history.pushState({'search': 'sok=' + search, 'hash': uid}, document.title, '?sok=' + encodeURIComponent(search) + '#' + uid);
        } else {
          history.pushState({'hash': uid}, document.title, '#' + uid);        
        }
      } else {
        window.location.hash = uid;
      }
    }
  }
};

NK.mapEventListeners = NK.mapEventListeners || {};
NK.mapEventListeners.moveend = NK.functions.updateHistory;
NK.mapEventListeners.zoomend = NK.functions.updateHistory;
NK.mapEventListeners.changelayer = NK.functions.updateHistory;
NK.mapEventListeners.changebaselayer = NK.functions.updateHistory;
