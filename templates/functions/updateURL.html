<%doc>
description: utility function to set the hashstate according to the definition in template readURL
</%doc>
var NK = NK || {};
NK.functions = NK.functions || {};

NK.functions.updateHistory = function (evt) {
    var center,
        zoom,
        i,
        layer,
        uid,
        search,
        searchInput;

    if (!!map) {
        center = map.getCenter();
        zoom = map.getZoom();

        if (!!center && !!zoom) {
            uid = zoom + "/" + Math.round(center.lon) + "/" + Math.round(center.lat);
            /* 1m precision ought to be enough for everyone --BG */
            if (NK.compactMode) {
              uid += "/*";
            }

            if (!!NK.initLayers && !!map.layers) {
                for (i in map.layers) {
                    if (map.layers.hasOwnProperty(i)) {
                        layer = map.layers[i];
                        if (!layer.isBaseLayer) {
                            if (!layer.isUrlDataLayer) {
                                if (layer.visibility) {
                                    if ($.inArray(layer.shortid, NK.initLayers) === -1 && typeof layer.shortid !== 'undefined') {
                                        uid += "/+" + layer.shortid;
                                    }
                                } else {
                                    if ($.inArray(layer.shortid, NK.initLayers) > -1 && typeof layer.shortid !== 'undefined') {
                                        uid += "/-" + layer.shortid;
                                    }
                                }
                            } else if (layer.visibility || layer.isStarred) {
                                if (layer.type == 'drawing') {
                                    uid += '/l/drawing/['+ layer.url.trim() +']';
                                } else if (layer.type == 'geojson') {
                                    uid += '/l/geojson/['+ layer.url.trim() +']';
                                } else if (layer.type == 'sosi') {
                                    uid += '/l/sosi/['+ layer.url.trim() +']';
                                } else if (layer.type == 'bbox') {
                                    uid += '/l/bbox/'+layer.url.trim();
                                } else if (layer.type == 'wms') {
                                    if (uid.indexOf(layer.url.trim())==-1) {
                                      uid += '/l/wms/[' + layer.url.trim() + ']';
                                    }
                                    var id = layer.params.LAYERS;
                                    var marker = layer.visibility ? "+" : "*";
                                    if (id.indexOf("/")>-1) {
                                      uid += '/['+marker+id+']';
                                    } else { 
                                      uid += '/'+marker+id;
                                    }
                                } else if (layer.type == 'wfs') {
                                    if (uid.indexOf(layer.protocol.origUrl.trim())==-1) {
                                      uid += '/l/wfs/[' + layer.protocol.origUrl.trim() + ']';
                                    }
                                    var id = layer.protocol.featureType;
                                    var marker = layer.visibility ? "+" : "*";
                                    if (id.indexOf("/")>-1) {
                                      uid += '/['+marker+id+']';
                                    } else { 
                                      uid += '/'+marker+id;
                                    }
                                    for (var f in layer.selectedFeatures) {
                                      var centroid = layer.selectedFeatures[f].geometry.getCentroid();
                                      uid += "/!"+id+"!"+Math.round(centroid.x)+","+Math.round(centroid.y);
                                    }
                                }
                                NK.functions.verifyDataLayers(layer);
                                if (!!layer.dataUrl) {
                                  uid += '/d/'+layer.dataType+'/['+layer.dataUrl.trim()+']';
                                }
                            }
                        }
                        if (layer.opacity<1.0) {
                          uid += "/o"+Math.floor(layer.opacity * 100);
                        }
                    }
                }
            }
        }
        searchInput = document.getElementById('searchInput');
        if (!!searchInput) {
            search = searchInput.value;
            if (history.replaceState) {
                if (!!search) {
                    history.replaceState({'search': 'sok=' + search, 'hash': uid}, document.title, '?sok=' + encodeURIComponent(search) + '#' + uid);
                } else {
                    history.replaceState({'hash': uid}, document.title, '#' + uid);
                }
            } else {
                window.location.hash = uid;
            }
        }
      NK.functions.updateScaleLine();
      NK.functions.createLegend();
    }
};

NK.mapEventListeners = NK.mapEventListeners || {};
NK.mapEventListeners.moveend = NK.functions.updateHistory;
NK.mapEventListeners.zoomend = NK.functions.updateHistory;
NK.mapEventListeners.changelayer = NK.functions.updateHistory;
NK.mapEventListeners.changebaselayer = NK.functions.updateHistory;

NK.functions.updateScaleLine = function () {
    var layers, scaleLine;
    if (!!self.map){
        layers = self.map.getLayersByName("Sj&oslash;")[0];
        if (!!layers) {
            if(layers.getVisibility()) {
                //NK.functions.addControlToContext(new OpenLayers.Control.ScaleLine({bottomOutUnits:'nm '}));
                scaleLine = map.getControlsByClass('OpenLayers.Control.ScaleLine');
                if (scaleLine.length > 0){
                    scaleLine[0].bottomOutUnits = 'nm';
                    scaleLine[0].bottomInUnits = 'nm';
                    scaleLine[0].eBottom.style.visibility = "visible";
                }
            } else {
                scaleLine = map.getControlsByClass('OpenLayers.Control.ScaleLine');
                if (scaleLine.length > 0){
                    scaleLine[0].bottomOutUnits = '';
                    scaleLine[0].bottomInUnits = '';
                    scaleLine[0].eBottom.style.visibility = "hidden";
                }
            }
        }
    }
}
