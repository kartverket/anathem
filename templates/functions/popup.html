%if not 'popupFunctions' in vars:

NK.functions = NK.functions || {};
NK.functions.popup = NK.functions.popup || {};
NK.data = NK.data || [];

NK.functions.popup.generatePopupMarkup = function (conf) {
  return function (feature) {
    var a = feature, i, j, l, markup = '', tmpMarkup = '', test;
    NK.data = [];
    var dict = {
      'stasjoner'                : {
        'info'   : {
          'name' : 'Fakta om Basestasjoner',
          'extra': 'Stasjonene samler GNSS-data som sendes til kartverkets kontrollsenter. GNSS-dataene brukes bl.a. til drift av kartverkets posisjonstjenester. ',
          'link' : '<a href="http://kartverket.no/Posisjonstjenester/" target="_blank">Les mer om stasjoner</a>'
        },
        'content': {
          'Stasjonsnavn:'   : 'sitename',
          'StasjonsId:'     : 'fourcharid',
          'Status:'         : 'operstattypename',
          'X-koordinater:'  : 'x',
          'Y-koordinater:'  : 'y',
          'Z-koordinater:'  : 'z',
          'Koordinatsystem:': 'coordsysname'
        },
        'data'   : {
          'data_json_array' : 'data_json_array',
          'avvik_json_array': 'avvik_json_array'
        }
      },
      'stasjoner_planlagt'       : {
        'info'   : {
          'name' : 'Fakta om Basestasjoner planlagt',
          'extra': 'Stasjonene samler GNSS-data som sendes til kartverkets kontrollsenter. GNSS-dataene brukes bl.a. til drift av kartverkets posisjonstjenester. ',
          'link' : '<a href="http://kartverket.no/Posisjonstjenester/" target="_blank">Les mer om stasjoner</a>'
        },
        'content': {
          'Stasjonsnavn:'   : 'sitename',
          'StasjonsId:'     : 'fourcharid',
          'Status:'         : 'operstattypename',
          'X-koordinater:'  : 'x',
          'Y-koordinater:'  : 'y',
          'Z-koordinater:'  : 'z',
          'Koordinatsystem:': 'coordsysname'
        },
        'data'   : {
          'data_json_array' : 'data_json_array',
          'avvik_json_array': 'avvik_json_array'
        }
      },
      'stasjoner_temp_outoforder': {
        'info'   : {
          'name' : 'Fakta om Basestasjoner temp out of order',
          'extra': 'Stasjonene samler GNSS-data som sendes til kartverkets kontrollsenter. GNSS-dataene brukes bl.a. til drift av kartverkets posisjonstjenester. ',
          'link' : '<a href="http://kartverket.no/Posisjonstjenester/" target="_blank">Les mer om stasjoner</a>'
        },
        'content': {
          'Stasjonsnavn:'   : 'sitename',
          'StasjonsId:'     : 'fourcharid',
          'Status:'         : 'operstattypename',
          'X-koordinater:'  : 'x',
          'Y-koordinater:'  : 'y',
          'Z-koordinater:'  : 'z',
          'Koordinatsystem:': 'coordsysname'
        },
        'data'   : {
          'data_json_array' : 'data_json_array',
          'avvik_json_array': 'avvik_json_array'
        }
      },
      'svenske_finske_stasjoner': {
        'info': {
          'name': 'Fakta om CPOS stasjoner',
          'extra': 'CPOS stasjonene samler GNSS-data som sendes til kartverkets kontrollsenter. GNSS-dataene brukes bl.a. til drift av kartverkets posisjonstjenester. ',
          'link' : '<a href="http://kartverket.no/Posisjonstjenester/" target="_blank">Les mer om CPOS stasjoner</a>'
        },
        'content': {
          'Stasjonsnavn:': 'sitename',
          'Stasjonsid:': 'fourcharid',
          'Status:': 'operstattypename',
          'X-koordinater:'  : 'x',
          'Y-koordinater:'  : 'y',
          'Z-koordinater:'  : 'z',
          'Koordinatsystem:': 'coordsysname'
        },
        'data'   : {
          'data_json_array' : 'data_json_array',
          'avvik_json_array': 'avvik_json_array'
        }
      },
      'niv_fastmerker'           : {
        'info'   : {
          'name' : 'Fakta om Fastmerker',
          'extra': 'Koordinatbestemte fastmerker er markert i terrenget med metallbolter som vanligvis er satt ned i fast fjell. Fastmerkene er inndelt i Stamnett, landsnett, trekantpunkter og høydefastmerker.',
          'link' : '<a href="http://www.kartverket.no/Kunnskap/Kart-og-kartlegging/Referanseramme/De-koordinatbestemte-fastmerkene" target="_blank">Les mer om Fastmerker</a>'
        },
        'content': {
          'Punktnummer:'       : 'punktnummer',
          'Punktnavn:'         : 'punktnavn',
          'Nord:'              : 'nord',
          'Øst:'               : 'ost',
          'Sone:'              : 'sone',
          'Høyde_nn2000:'      : 'hoyde_nn2000',
          'Høyde_nn1954:'      : 'hoyde_nn1954',
          'Ellipsoidisk_høyde:': 'ellipsoidisk_hoyde',
          'Punkttype:'         : 'punkttype',
          'Underlag:'          : 'underlag',
          'Kvalitet_nn1954:'   : 'kvalitet_nn1954',
          'Kvalitet_grunnriss:': 'kvalitet_grunnriss',
          'Status:'            : 'status',
          'Status_år:'         : 'status_ar',
          'Beskrivelse:'       : 'beskrivelse'
        }
      },
      'trekantpunkt'             : {
        'info'   : {
          'name' : 'Fakta om Fastmerker',
          'extra': 'Koordinatbestemte fastmerker er markert i terrenget med metallbolter som vanligvis er satt ned i fast fjell. Fastmerkene er inndelt i Stamnett, landsnett, trekantpunkter og høydefastmerker.',
          'link' : '<a href="http://www.kartverket.no/Kunnskap/Kart-og-kartlegging/Referanseramme/De-koordinatbestemte-fastmerkene" target="_blank">Les mer om Fastmerker</a>'
        },
        'content': {
          'Punktnummer:'       : 'punktnummer',
          'Punktnavn:'         : 'punktnavn',
          'Nord:'              : 'nord',
          'Øst:'               : 'ost',
          'Sone:'              : 'sone',
          'Høyde_nn2000:'      : 'hoyde_nn2000',
          'Høyde_nn1954:'      : 'hoyde_nn1954',
          'Ellipsoidisk_høyde:': 'ellipsoidisk_hoyde',
          'Punkttype:'         : 'punkttype',
          'Underlag:'          : 'underlag',
          'Kvalitet_nn1954:'   : 'kvalitet_nn1954',
          'Kvalitet_grunnriss:': 'kvalitet_grunnriss',
          'Status:'            : 'status',
          'Status_år:'         : 'status_ar',
          'Beskrivelse:'       : 'beskrivelse'
        }
      },
      'stamnettpunkt'            : {
        'info'   : {
          'name' : 'Fakta om Fastmerker',
          'extra': 'Koordinatbestemte fastmerker er markert i terrenget med metallbolter som vanligvis er satt ned i fast fjell. Fastmerkene er inndelt i Stamnett, landsnett, trekantpunkter og høydefastmerker.',
          'link' : '<a href="http://www.kartverket.no/Kunnskap/Kart-og-kartlegging/Referanseramme/De-koordinatbestemte-fastmerkene" target="_blank">Les mer om Fastmerker</a>'
        },
        'content': {
          'Punktnummer:'       : 'punktnummer',
          'Punktnavn:'         : 'punktnavn',
          'Nord:'              : 'nord',
          'Øst:'               : 'ost',
          'Sone:'              : 'sone',
          'Høyde_nn2000:'      : 'hoyde_nn2000',
          'Høyde_nn1954:'      : 'hoyde_nn1954',
          'Ellipsoidisk_høyde:': 'ellipsoidisk_hoyde',
          'Punkttype:'         : 'punkttype',
          'Underlag:'          : 'underlag',
          'Kvalitet_nn1954:'   : 'kvalitet_nn1954',
          'Kvalitet_grunnriss:': 'kvalitet_grunnriss',
          'Status:'            : 'status',
          'Status_år:'         : 'status_ar',
          'Beskrivelse:'       : 'beskrivelse'
        }
      },
      'landsnettpunkt'           : {
        'info'   : {
          'name' : 'Fakta om Fastmerker',
          'extra': 'Koordinatbestemte fastmerker er markert i terrenget med metallbolter som vanligvis er satt ned i fast fjell. Fastmerkene er inndelt i Stamnett, landsnett, trekantpunkter og høydefastmerker.',
          'link' : '<a href="http://www.kartverket.no/Kunnskap/Kart-og-kartlegging/Referanseramme/De-koordinatbestemte-fastmerkene" target="_blank">Les mer om Fastmerker</a>'
        },
        'content': {
          'Punktnummer:'       : 'punktnummer',
          'Punktnavn:'         : 'punktnavn',
          'Nord:'              : 'nord',
          'Øst:'               : 'ost',
          'Sone:'              : 'sone',
          'Høyde_nn2000:'      : 'hoyde_nn2000',
          'Høyde_nn1954:'      : 'hoyde_nn1954',
          'Ellipsoidisk_høyde:': 'ellipsoidisk_hoyde',
          'Punkttype:'         : 'punkttype',
          'Underlag:'          : 'underlag',
          'Kvalitet_nn1954:'   : 'kvalitet_nn1954',
          'Kvalitet_grunnriss:': 'kvalitet_grunnriss',
          'Status:'            : 'status',
          'Status_år:'         : 'status_ar',
          'Beskrivelse:'       : 'beskrivelse'
        }
      }
    };
    test = a.split("\n");
    if (test.length > 5) {
      markup += '<article style="overflow-y: auto; height:380px" >';
      a = feature.replace(/Layer/g, ",,Layer");
      a = a.split(",,");
      for (i = 0; i < a.length; ++i) {
        if (a[i].substring(0, 5) == "Layer") {
          //Layer
          tmpMarkup = '';
          var tmp = a[i].replace(/'/g, "").toLowerCase().split(" ");
          var dictTmp = dict[tmp[1].trim()];
          var tmpResp = [];
          markup += '<h4 style="margin-bottom:5px">' + dictTmp['info']['name'] + '</h4>';
          markup += '<p  style="margin-bottom:5px">' + dictTmp['info']['extra'] + '<p>';
          markup += '<div class="externalToolbarLink">' + dictTmp['info']['link'] + '</div>';
          markup += '<h4 class="h">Lag : ' + tmp[1].trim() + '</h4>';
          var f = a[i].replace(/Feature/g, ",,Feature");
          f = f.split(",,");
          for (l = 0; l < f.length; l++) {
            //feature
            if (f[l].substring(0, 7) == "Feature") {
              var pgsdata;
              var avvik_data;
              f[l].split("\n").forEach(function (element, index, array) {
                if (element.trim().startsWith('data_json_array')) {
                  pgsdata = element.replace(/'/g, "").split(' = ');
                  if (pgsdata[1] !== '[null]') {
                    pgsdata = JSON.parse(pgsdata[1]);
                  } else {
                    pgsdata = '';
                  }
                }
                if (element.trim().startsWith('avvik_json_array')) {
                  avvik_data = JSON.parse(element.replace(/'/g, "").split(' = ')[1]);
                }
              });
              tmpMarkup += '<div class="featureInfo" style="border-top: 1px solid;">';
              try {
                tmp = f[l].split(":");
                if (tmp.length > 2) {
                  tmp[1] = tmp[1].concat(tmp[2]);
                }
                tmp = tmp[1].split('\'\n');
                for (j = 0; j < tmp.length; j++) {
                  var keyValuePair = tmp[j].trim();
                  keyValuePair = keyValuePair.replace(/'/g, "").split(' = ');
                  if (keyValuePair[1]) {
                    tmpResp[keyValuePair[0]] = keyValuePair[1];
                  }
                }

                for (var prop in dictTmp['content']) {
                  tmpMarkup += '<p style="display: table-row;"><span class="prop" style="display: table-cell;">' + prop + '</span><span class="value" style="display: table-cell">';
                  if (!!tmpResp[dictTmp.content[prop]]) {
                    if (!!dictTmp.content[prop]) {
                      tmpMarkup += tmpResp[dictTmp.content[prop]];
                    }
                    tmpMarkup += '</span></p>';
                  } else {
                    if (typeof dictTmp.content[prop] === 'object') {
                      for (var internprop in dictTmp.content[prop]) {
                        tmpMarkup += tmpResp[internprop] + dictTmp.content[prop][internprop];
                      }
                    } else {
                      tmpMarkup += '</p>';
                    }
                  }
                }

                if (!!pgsdata) {
                  var stasjonsid = tmpResp[dictTmp.content['StasjonsId:']];
                  tmpMarkup += "<div style='font-weight:bold;'>&nbsp;Tidsserier</div><canvas id='pgsChart" + stasjonsid + "' width='350' height='300'></canvas>";

                  var data = {
                    labels  : [],
                    datasets: [
                      {
                        label           : "North",
                        data            : [],
                        borderColor     : "rgba(200,100,100,1)",
                        pointStrokeColor: "rgba(200,100,100,0)",
                        pointRadius: 0,
    pointHitRadius: 5,
    fill: false
                      },
                      {
                        label           : "East", data: [],
                        borderColor     : "rgba(100,200,100,1)",
                        pointStrokeColor: "rgba(100,200,100,0)",
    pointRadius: 0,
    pointHitRadius: 5,
    fill: false
    },
                      {
                        label           : "Height",
                        data            : [],
                        borderColor     : "rgba(100,100,200,1)",
                        pointStrokeColor: "rgba(100,100,200,0)",
    pointRadius: 0,
    pointHitRadius: 5,
    fill: false
    }
                    ]
                  };
                  pgsdata.sort(function (a, b) {return a['tid'] - b['tid']});
                  var refh = pgsdata.slice(-1)[0]['h'];
                  var refn = pgsdata.slice(-1)[0]['n'];
                  var refe = pgsdata.slice(-1)[0]['e'];

                  for (var entry in pgsdata) {
                    var dato = pgsdata[entry]['tid'];
                    var aar = 2000 + Math.floor(dato);
                    var maned = Math.floor((2000 + dato - aar) * 12) + 1;
                    if (maned.toString().length == 1) {
                      maned = "0" + maned;
                    }

                    //data['labels'].push(pgsdata[entry]['tid'].toString().substring(0,5));
                    data['labels'].push(aar + "-" + maned);
                    data['datasets'][0]['data'].push(((pgsdata[entry]['n'] - refn) * 1000).toFixed(2));
                    data['datasets'][1]['data'].push(((pgsdata[entry]['e'] - refe) * 1000).toFixed(2));
                    data['datasets'][2]['data'].push(((pgsdata[entry]['h'] - refh) * 1000).toFixed(2));
                  }

                  var options = {
                    scales     : {
                      xAxes: [{
                        gridLines : {color: "rgba(255,255,255,0.6)"},
                        scaleLabel: {display: true, fontColor: "rgba(255,255,255,1)"}
                      }],
                      yAxes: [{
                        gridLines : {color: "rgba(255,255,255,0.6)"},
                        scaleLabel: {display: true, fontColor: "rgba(255,255,255,1)"}
                      }]
                    }
                  };
                  NK.data.push([stasjonsid, data, options]);

                  Chart.types.Line.extend({
                    name: "AltLine",
                    initialize: function (data) {
                      Chart.types.Line.prototype.initialize.apply(this, arguments);
                      this.scale.draw = function () {
                        if (this.display && (this.xLabelRotation > 90)) {
                          this.endPoint = this.height - 5;
                        }
                        Chart.Scale.prototype.draw.apply(this, arguments);
                      };
                    }
                  });

                }
              } catch (e) {
              }
              tmpMarkup += '</div>';
            }
          }
          markup += tmpMarkup;
        }
      }
    } else {
      markup += '<article><p>Vi har ingen data for dette punktet</p>';
    }
    markup += '<div class="externalToolbarLink">Kilde: <a href="http://www.kartverket.no" target="_blank">Kartverket</a></div></article>';
    return markup;
  };

};

NK.functions.popup.getFeatureSelector = function (M, markupGeneratorFunction, popupCloseFunction, options) {
  var featureSelector = options.selectControl;
  return function (feature) {
    var popup,
        message,
        mousePosition,
        featurePosition,
        popupPosition,
        offset = {},
        sameFidFeatures,
        xOffset,
        yOffset,
        i, j;

    if (feature.cluster) {
      return false;
    }

    if (NK.easyXDM && NK.easyXDM.socket) {
      // there is an active easyXDM socket - send feature data
      message = {
        cmd: 'featureSelected',
        feature: feature.fid,
        attributes: feature.attributes,
        layer: feature.layer.shortid
      };
      NK.easyXDM.socket.postMessage(JSON.stringify(message));
    }

    if (feature.fid && feature.layer) {
      sameFidFeatures = feature.layer.getFeaturesByFid(feature.fid);
      for (i = 0, j = sameFidFeatures.length; i < j; i += 1) {
        feature.layer.selectedFeatures.push(sameFidFeatures[i]);
        this.highlight.apply(this, [sameFidFeatures[i]]);
      }
    }

    // find out where to position the popup
    if (options && options.featureCentroidPosition) {
      featurePosition = feature.geometry.getBounds().getCenterLonLat();

      if (featurePosition) {
        xOffset = feature.layer.styleMap.styles[feature.renderIntent].defaultStyle.graphicXOffset || feature.layer.styleMap.styles['default'].defaultStyle.graphicXOffset || 0;
        xOffset += (feature.layer.styleMap.styles[feature.renderIntent].defaultStyle.graphicWidth || feature.layer.styleMap.styles['default'].defaultStyle.graphicWidth) / 2;
        yOffset = feature.layer.styleMap.styles[feature.renderIntent].defaultStyle.graphicYOffset || feature.layer.styleMap.styles['default'].defaultStyle.graphicYOffset || 0;

        if (xOffset || yOffset) {
          offset.x = -5;
          offset.y = -18;
          offset.addX = xOffset;
          offset.addY = yOffset;
        }
      }
    }

    mousePosition = map.getLonLatFromPixel((map.getControlsByClass('OpenLayers.Control.MousePosition')[0]).lastXy);
    popupPosition = featurePosition || mousePosition;

    M.panTo(popupPosition);

    popup = new OpenLayers.Popup.FramedSideAnchored(
      "nk-selected-coverage-map",
      popupPosition,
      null,
      markupGeneratorFunction(feature),
      null,
      true,
      popupCloseFunction,
      offset,
      'selected-feature-popup'
    );

    popup.autoSize = true;
    feature.popup = popup;
    popup.feature = feature;
    M.addPopup(popup);
  };
};

NK.functions.popup.addConfiguredPopup = function (M, layer, popupConfig) {
  var generatePopupMarkup,
      onFeatureSelect,
      onFeatureUnselect,
      onPopupClose,
      selectControl;

  generatePopupMarkup = NK.functions.popup.generatePopupMarkup(popupConfig);
  onPopupClose = function (evt) {
    if (this.feature) {
      selectControl.unselect(this.feature);
    }
  };

  onFeatureSelect = NK.functions.popup.getFeatureSelector(M, generatePopupMarkup, onPopupClose, popupConfig);
  onFeatureUnselect = function (feature) {
      if (feature.popup) {
        feature.popup.feature = null;
        M.removePopup(feature.popup);
        feature.popup.destroy();
        feature.popup = null;
      }
  };

  selectControl = new OpenLayers.Control.SelectFeature(layer, {
      onUnselect: onFeatureUnselect,
      highlightOnly: true,
      autoActivate: true
  });
  selectControl.onSelect = OpenLayers.Function.bind(onFeatureSelect, selectControl);

  M.addControl(selectControl);
};

<% vars['popupFunctions']=True %>
%endif
