% if not 'popupFunctions' in vars:  

NK.functions = NK.functions || {};
NK.functions.popup = NK.functions.popup || {};

NK.functions.popup.generatePopupMarkup = function (conf) {
  return function (feature) {
    var a = feature.attributes,
        i,
        l,
        markup = '<article>';

    if (conf.heading && a[conf.heading]) {
      markup += '<h1 class="h">' + a[conf.heading] + '</h1>';
    }
    if (conf.data) {
      for (i = 0, l = conf.data.length; i < l; i += 1) {
        if (conf.data[i].attribute && a[conf.data[i].attribute]) {
          markup += '<p>' + OpenLayers.Lang.translate(conf.data[i].label) + ': ' + a[conf.data[i].attribute] + ' '+ conf.data[i].unit +'</p>';
        }
      }
    }
    markup += '</article>';
    return markup;
  };
};
NK.functions.popup.generatePopupMarkup2 = function (conf) {
  return function (feature) {
    var a = feature,
    i,
    l,
    markup = '<article style="overflow-y: scroll;">',
    tmpMarkup = '';

    var test;
    test = a.split("\n");

  var uuDict = {
  "adko_ru_led":"Atkomstvei rullestol med ledsager: ",
  "adko_rull":"Atkomstvei rullestol: ",
  "adko_syns":"Atkomstvei synshemmede: ",
  "dekke":"Dekke: ",
  "diameter":"Diameter: ",
  "flytebrygge":"Flytebrygge: ",
  "registrert":"Registrert: ",
  "kommentar":"Kommentar: ",
  "plankeavstand":"Plankeavstand: ",
  "rekkverk":"Rekkverk: ",
  "stoppka_hoyde":"Stoppkant høyde: ",
  "adko_el_rulle":"Atkomstvei el. rullestol: ",
  "stoppkant":"Stoppkant: ",
  "oppdatert":"Oppdatert: ",
  "ringeklokke":" ",
  "naturbase_nr":" ",
  "hytteeier":" ",
  "adko_stig_forhold":" ",
  "tverrfall":" ",
  "shape_area":" ",
  "feil":" ",
  "t_tur_syn":" ",
  "tilgj_automat":" ",
  "bord_utstikk":" ",
  "spesialfottyperute":" ",
  "t_alt":" ",
  "t_auto_rulle":" ",
  "helning":" ",
  "gnr":" ",
  "gid":" ",
  "hoyde_skranke":" ",
  "badeplass_tilrettelagt_for":" ",
  "t_bad_syn":"Tilgjengelig svaksynt: ",
  "belysning":" ",
  "bnr":" ",
  "aut_hoyde":" ",
  "skiltet":" ",
  "turomraade":" ",
  "lyssignal":" ",
  "rampe_stig":"Rampestigning: ",
  "bord_hoyde":" ",
  "kap_personbiler":" ",
  "hytte_id":" ",
  "merket":" ",
  "rampe_bredde":"Rampe bredde: ",
  "byggtype":" ",
  "varmekabel":" ",
  "nedsenk_1":" ",
  "eierforhold":" ",
  "dorapner":" ",
  "terskel_hoyde":" ",
  "overbygg":" ",
  "navn":" ",
  "gate_type":" ",
  "ringekl_hoyde":" ",
  "t_fisk_syn":"Tilgjengelig svaksynt: ",
  "X":" ",
  "landga_stig":" ",
  "bredde":" ",
  "t_syn":" ",
  "komm":" ",
  "kommunenr":" ",
  "opphav":" ",
  "stig_forhold":" ",
  "naturbasenr":" ",
  "wkb_geometry":" ",
  "nedsenk_2":" ",
  "kommunenavn":" ",
  "moteplass":" ",
  "t_elrull":" ",
  "inngang_bredde":" ",
  "storrelse":" ",
  "man_knap_hoyde":" ",
  "inngang_type":" ",
  "adko_stig_grad":" ",
  "fiskeplass":" ",
  "eier_tekst":" ",
  "rampe_tverrfall":"Rampe tverrfall: ",
  "turomraade_tilrettelagt_for":" ",
  "kontrast":" ",
  "t_man_rulle":" ",
  "dortype":" ",
  "avstand_servicebygg":" ",
  "subtypekod":" ",
  "tilgjengelighet_mulig":" ",
  "stigning":" ",
  "frihoyde":" ",
  "bilde":" ",
  "lengde":" ",
  "link_skjema":" ",
  "avstand_park":" ",
  "t_rulleled":" ",
  "rampe":"Rampe: ",
  "objtype":" ",
  "veitype":" ",
  "t_bad_rulle":"Tilgjengelig rullestol: ",
  "t_fisk_rulle":"Tilgjengelig rullestol: ",
  "kap_uu":" ",
  "avstand_hc_park":" ",
  "fiskeplass_tilrettelagt_for":" ",
  "ptema":" ",
  "rampe_tilgjengelig":" ",
  "hand_hoy_1":" ",
  "t_rulle":" ",
  "malemetode":" ",
  "ledelinje":" ",
  "lydsignal":" ",
  "atko_stigning":" ",
  "hand_hoy_2":" ",
  "badeplass":" ",
  "tverrfall_grad":" ",
  "userid":" ",
  "t_rullled":" ",
  "forbed_forslag":"Forbedringsforslag: ",
  "byggnr":" ",
  "objectid":" ",
  "led_lin_kontrast":" ",
  "byggtyp_nb":" ",
  "avstand_serv_bygg":" ",
  "t_tur_rulle":" ",
  "tilrettela":"Tilrettelegging: ",
  "kontrast_inngang":" ",
  "shape_length":" ",
  "avgift":"Avgift: ",
  "betjenings":" ",
  "atko_stigforhold":" ",
  "dekke_tilstand":" ",
  "ogc_fid":" ",
  "noyaktighe":" ",
  "handlist":" ",
  "link_bilde":" ",
  "operator":" ",
  "hoyde_inngang":" ",
  "arstidbruk":" ",
  "tilgj_aut":" ",
  "feil_løsning":" ",
  "bygg_funksjon":" ",
  "lenke":" ",
  "stig_grad":" ",
  "status":"Status: ",
  "webside":"Webside: ",
  "lok_navn":"Navn: ",
  "lok_id":"Lok-ID: ",
  "kategori_2":"Kategori: "
  };

  if(test.length > 4) {
      var tmp = test[2].replace(/'/g,"").toUpperCase().split(" ");
      var uuDictResponse = [];
      markup += '<h1 class="h">' + tmp[1] + '</h1>';
      markup += '<div class="externalToolbarLink"><a href="http://kartverket.no/tilgjengelighet/"><br>Les mer om Tilgjengelighetstjenester</a></div>';
      for (i = 5, l = test.length - 1; i < l; i +=1) {
        tmp = test[i].split(" = ");
        if (uuDict[tmp[0].trim()] !== " ") {
          tmpMarkup += '<p>' + uuDict[tmp[0].trim()] + tmp[1] + '</p>';
        }
        if(!!tmp[1]){
          uuDictResponse[tmp[0].trim()] = tmp[1].replace(/'/g,"");
        }
      }
      markup += '<table style="width:80px"><tr>';
      if(!!uuDictResponse['t_rulle']){
      markup += '<td id="flat_td"><img src="http://data.kartverket.no/tilgjengelighet/symboler/rullestol/' + uuDictResponse['t_rulle'] + '.png" /></td>';
      }
      if(!!uuDictResponse['t_syn']){
      markup += '<td><img src="http://data.kartverket.no/tilgjengelighet/symboler/syn/' + uuDictResponse['t_syn'] + '.png" /></td>';
      }
      if(!!uuDictResponse['t_rullled']){
      markup += '<td><img src="http://data.kartverket.no/tilgjengelighet/symboler/rullestol_led/' + uuDictResponse['t_rullled'] + '.png" /></td>';
      }
      if(!!uuDictResponse['t_elrull']){
      markup += '<td><img src="http://data.kartverket.no/tilgjengelighet/symboler/rullestol_el/' + uuDictResponse['t_elrull'] + '.png" /></td>';
      }
      if(!!uuDictResponse['t_tur_rulle']){
      markup += '<td><img src="http://data.kartverket.no/tilgjengelighet/symboler/rullestol/' + uuDictResponse['t_tur_rulle'] + '.png" /></td>';
      }
      if(!!uuDictResponse['t_tur_syn']){
      markup += '<td><img src="http://data.kartverket.no/tilgjengelighet/symboler/syn/' + uuDictResponse['t_tur_syn'] + '.png" /></td>';
      }
      markup += '</tr></table>';
      if (!!uuDictResponse['bilde']) {
        markup += '<a href="http://data.kartverket.no/tilgjengelighet/' + uuDictResponse['bilde'] + '"><img height=200 width=250 SRC="http://data.kartverket.no/tilgjengelighet/' + uuDictResponse['bilde'] +'"></a>';
      }
    } else {
      markup += "Ingen data for denne punkt";
    }

    markup += tmpMarkup + '</article>';
    return markup;
  };
};
NK.functions.popup.getFeatureSelector = function (M, markupGeneratorFunction, popupCloseFunction, options) {
  var featureSelector = options.selectControl;
  return function (feature) {
    var popup, 
        message, 
        mousePosition,
        featurePosition,
        popupPosition,
        offset = {},
        sameFidFeatures,
        xOffset,
        yOffset,
        i, j;

    if (feature.cluster) {
      return false;
    }

    if (NK.easyXDM && NK.easyXDM.socket) {
      // there is an active easyXDM socket - send feature data
      message = {
        cmd: 'featureSelected', 
        feature: feature.fid,
        attributes: feature.attributes,
        layer: feature.layer.shortid
      };
      NK.easyXDM.socket.postMessage(JSON.stringify(message));
    }

    if (feature.fid && feature.layer) {

      sameFidFeatures = feature.layer.getFeaturesByFid(feature.fid);
      for (i = 0, j = sameFidFeatures.length; i < j; i += 1) {
        feature.layer.selectedFeatures.push(sameFidFeatures[i]);

        this.highlight.apply(this, [sameFidFeatures[i]]);
      } 
    }

    // find out where to position the popup
    if (options && options.featureCentroidPosition) {
      featurePosition = feature.geometry.getBounds().getCenterLonLat();

      if (featurePosition) {
        xOffset = feature.layer.styleMap.styles[feature.renderIntent].defaultStyle.graphicXOffset || feature.layer.styleMap.styles['default'].defaultStyle.graphicXOffset || 0;
        xOffset += (feature.layer.styleMap.styles[feature.renderIntent].defaultStyle.graphicWidth || feature.layer.styleMap.styles['default'].defaultStyle.graphicWidth) / 2;
        yOffset = feature.layer.styleMap.styles[feature.renderIntent].defaultStyle.graphicYOffset || feature.layer.styleMap.styles['default'].defaultStyle.graphicYOffset || 0;

        if (xOffset || yOffset) {
          offset.x = -5;
          offset.y = -18;
          offset.addX = xOffset;
          offset.addY = yOffset;
        }
      }
    }

    mousePosition = map.getLonLatFromPixel((map.getControlsByClass('OpenLayers.Control.MousePosition')[0]).lastXy);
    popupPosition = featurePosition || mousePosition;

    M.panTo(popupPosition);

    popup = new OpenLayers.Popup.FramedSideAnchored(
      "nk-selected-coverage-map", 
      popupPosition,
      null,
      markupGeneratorFunction(feature),
      null, 
      true, 
      popupCloseFunction,
      offset,
      'selected-feature-popup'
    );

    popup.autoSize = true;
    feature.popup = popup;
    popup.feature = feature;
    M.addPopup(popup);
  
  };
};

NK.functions.popup.addConfiguredPopup = function (M, layer, popupConfig) {

  var generatePopupMarkup,
      onFeatureSelect,
      onFeatureUnselect,
      onPopupClose,
      selectControl;
      
  generatePopupMarkup = NK.functions.popup.generatePopupMarkup(popupConfig);

  onPopupClose = function (evt) {
    if (this.feature) {
      selectControl.unselect(this.feature);
    }
  };

  onFeatureSelect = NK.functions.popup.getFeatureSelector(M, generatePopupMarkup, onPopupClose, popupConfig);

  onFeatureUnselect = function (feature) {
      if (feature.popup) {
        feature.popup.feature = null;
        M.removePopup(feature.popup);
        feature.popup.destroy();
        feature.popup = null;
      }
  };

  selectControl = new OpenLayers.Control.SelectFeature(layer, {
      onUnselect: onFeatureUnselect,
      highlightOnly: true,
      autoActivate: true
  });
  selectControl.onSelect = OpenLayers.Function.bind(onFeatureSelect, selectControl);

  M.addControl(selectControl);

};

<% vars['popupFunctions']=True %>
%endif
