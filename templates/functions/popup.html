<%doc>description: utility functions used by popup code</%doc>
% if not 'popupFunctions' in vars:  

NK.functions = NK.functions || {};
NK.functions.popup = NK.functions.popup || {};

NK.functions.popup.smartData = function (str) {
  if (str.indexOf('://')>-1) {
    return '<a href="' + str + '" style="color:#fff">' + str + '</a>';
  }
  return str;
}

NK.functions.popup.generatePopupMarkup = function (conf) {
  return function (feature) {
    var a = feature.attributes, attr,
        i,
        l,
        markup = '<article>';

    if (!!conf.heading && a[conf.heading]) {
      markup += '<h1 class="h">' + a[conf.heading] + '</h1>';
    }
    markup += "<table>";
    if (!!conf.data) {
      for (i = 0, l = conf.data.length; i < l; i += 1) {
        if (conf.data[i].attribute && a[conf.data[i].attribute]) {
          markup += '<tr><td>' + OpenLayers.Lang.translate(conf.data[i].label) + ': </td><td>' + a[conf.data[i].attribute] + ' '+ conf.data[i].unit +'</td></tr>';
        }
      }
    } else { // this popup is not actually configured
      for (attr in a) {
        markup += '<tr><td>' + attr + ': </td><td>' + NK.functions.popup.smartData( a[attr] ) + '</td></tr>';
      }
    }
    markup += '</table></article>';
    if (a.length > 10) {
      return '<div style="overflow:scroll">'+markup+'</div>';
    } else {
      return markup;
    }
  };
};
NK.functions.popup.wmsFeatureInfoPopup = function (event, formats) {
  if (!event.text || !event.text.trim().length) {
    return "Ingen informasjon.";
  }
  var html;
  if (event.object.infoFormat == "text/xml") {
    var data = [];
    $(event.text).find("FIELDS").each(function() {
      var attributes = $(this)[0].attributes;
      var fields = {};
      for (var a=0;a<attributes.length;a++) {
        fields[attributes[a].localName] = attributes[a].value;
      }
      data.push(fields);
    });
    var content = '<ul>';
    for (var x in data) { 
      content += '<li>';
      for (var key in data[x]) {
        content += key + ': ' + data[x][key] + '<br/>';
      }
      content += '</li>';
    }
    html = '<div style="width:100%; max-height:300px; overflow-y:scroll background-color:#555; margin-left:10px">'+content+'</div>';
  }
  else if (event.object.infoFormat == "text/html") {
    html = '<div style="width:100%; max-height:300px; overflow:scroll; background-color:#fff; color:#000">'+event.text+'</div>';
  }
  else if (event.object.infoFormat == "text/plain") {
    html = '<div style="max-height:300px; overflow-y:scroll; background-color:#555"><pre>'+event.text+'</pre></div>';
  }
  var request = decodeURIComponent(event.request._object.responseURL);
  for (var f in formats) {
    var url = request.replace(event.object.infoFormat, formats[f]);
    html += '<a href="'+url+'" target="_blank">'+formats[f]+'</a> ';
  }
  return html;
};
NK.functions.popup.getFeatureSelector = function (M, markupGeneratorFunction, popupCloseFunction, options) {
  var featureSelector = options.selectControl;
  return function (feature) {
    var popup, 
        message, 
        mousePosition,
        featurePosition,
        popupPosition,
        offset = {},
        sameFidFeatures,
        xOffset,
        yOffset,
        i, j;

    if (feature.cluster) {
      return false;
    }

    if (NK.easyXDM && NK.easyXDM.socket) {
      // there is an active easyXDM socket - send feature data
      message = {
        cmd: 'featureSelected', 
        feature: feature.fid,
        attributes: feature.attributes,
        layer: feature.layer.shortid
      };
      NK.easyXDM.socket.postMessage(JSON.stringify(message));
    }

    if (feature.fid && feature.layer) {

      sameFidFeatures = feature.layer.getFeaturesByFid(feature.fid);
      for (i = 0, j = sameFidFeatures.length; i < j; i += 1) {
        feature.layer.selectedFeatures.push(sameFidFeatures[i]);

        this.highlight.apply(this, [sameFidFeatures[i]]);
      } 
    }

    // find out where to position the popup
    if (options && options.featureCentroidPosition) {
      featurePosition = feature.geometry.getBounds().getCenterLonLat();

      if (featurePosition) {
        xOffset = feature.layer.styleMap.styles[feature.renderIntent].defaultStyle.graphicXOffset || feature.layer.styleMap.styles['default'].defaultStyle.graphicXOffset || 0;
        xOffset += (feature.layer.styleMap.styles[feature.renderIntent].defaultStyle.graphicWidth || feature.layer.styleMap.styles['default'].defaultStyle.graphicWidth) / 2;
        yOffset = feature.layer.styleMap.styles[feature.renderIntent].defaultStyle.graphicYOffset || feature.layer.styleMap.styles['default'].defaultStyle.graphicYOffset || 0;

        if (xOffset || yOffset) {
          offset.x = -5;
          offset.y = -18;
          offset.addX = xOffset;
          offset.addY = yOffset;
        }
      }
    }

    mousePosition = map.getLonLatFromPixel((map.getControlsByClass('OpenLayers.Control.MousePosition')[0]).lastXy);
    popupPosition = featurePosition || mousePosition;

    M.panTo(popupPosition);

    popup = new OpenLayers.Popup.FramedSideAnchored(
      "nk-selected-coverage-map", 
      popupPosition,
      null,
      markupGeneratorFunction(feature),
      null, 
      true, 
      popupCloseFunction,
      offset,
      'selected-feature-popup'
    );

    popup.autoSize = true;
    feature.popup = popup;
    popup.feature = feature;
    M.addPopup(popup);
  
  };
};

NK.functions.popup.addConfiguredPopup = function (M, layer, popupConfig) {

  var generatePopupMarkup,
      onFeatureSelect,
      onFeatureUnselect,
      onPopupClose,
      selectControl;

  popupConfig = popupConfig || {};
      
  generatePopupMarkup = NK.functions.popup.generatePopupMarkup(popupConfig);

  onPopupClose = function (evt) {
    if (this.feature) {
      selectControl.unselect(this.feature);
    }
  };

  onFeatureSelect = NK.functions.popup.getFeatureSelector(M, generatePopupMarkup, onPopupClose, popupConfig);

  onFeatureUnselect = function (feature) {
      if (feature.popup) {
        feature.popup.feature = null;
        M.removePopup(feature.popup);
        feature.popup.destroy();
        feature.popup = null;
      }
  };

/*  selectControl = new OpenLayers.Control.SelectFeature(layer, {
      onUnselect: onFeatureUnselect,
      highlightOnly: true,
      autoActivate: true
  });
  selectControl.onSelect = OpenLayers.Function.bind(onFeatureSelect, selectControl); 

  M.addControl(selectControl); */

};

<% vars['popupFunctions']=True %>
%endif
