<%doc>
description: The base javascript for the norgeskart.no and geoportal map client
params: 
  i18n: (TEMPLATE) code for internationalization
  functions: (TEMPLATE) a list of map functions to include before loading the main map
  tokenServiceUrl: URL to retrieve a Gatekeeper token for WMS services
  projection: Base projection of the map (EPSG code) 
  language: language code to be used for i18n (nb, en, ...)
  center: (TEMPLATE) include code to set variables NK.defaultCenter and NK.defaultZoom
  styles: (TEMPLATE) list of style definitions to include for vector layers
  baselayers: (TEMPLATE) definition for the base layer of the map
  overlays: (TEMPLATE) list of definitions for overlay (not base) layers on the map
  controls: (TEMPLATE) list of OpenLayers controls to include in the client
</%doc>
"use strict";

var NK = NK || {};
NK.mapEventListeners = {};

var gkopen,
    gkopen_wmts,
    proj,
    mapProj,
    bounds,
    mapBounds,
    xdmsocket,
    initLayers,
    postEvent,
    map;

gkopen = "http://opencache.statkart.no/gatekeeper/gk/gk.open";
gkopen_wmts = "http://opencache.statkart.no/gatekeeper/gk/gk.open_wmts";

NK.gkToken = "unInitialized";

% if tokenServiceUrl:
NK.tokenService = "${tokenServiceUrl}";
% endif

NK.baseProjection = "32633";
% if projection:
NK.baseProjection = "${projection}";
% endif

NK.tokenLastUpdated = new Date(0);
NK.tokenUpdatePaused = false;

% if i18n:
  ${i18n}
% endif

NK.tokenError = {
  PAUSE_MINUTES: 2,
  RELOAD_LIMIT_SECONDS: 15,
  messagePopup: null,
  pauseTimeRemainingElement: null,
  pauseTimeRemainingText: null,
  pauseTimer: null,
  pauseCountdownTimer: null
};


NK.mapservers = {};
NK.mapservers.wmts = [
//  "http://skrivte58:8080/geowebcache/service/wmts",
  "http://gatekeeper1.geonorge.no/BaatGatekeeper/gk/gk.cache_wmts",
  "http://gatekeeper2.geonorge.no/BaatGatekeeper/gk/gk.cache_wmts",
  "http://gatekeeper3.geonorge.no/BaatGatekeeper/gk/gk.cache_wmts"
];
NK.zoomLevels = 18;

NK.functions = NK.functions || {};

NK.functions.resetTokenError = function () {
  if (NK.tokenError.pauseTimeRemainingElement) {
    NK.tokenError.pauseTimeRemainingElement.parentNode.removeChild(NK.tokenError.pauseTimeRemainingElement);
    NK.tokenError.pauseTimeRemainingElement = null;
  }
  if (NK.tokenError.messagePopup) {
    NK.tokenError.messagePopup.parentNode.removeChild(NK.tokenError.messagePopup);
    NK.tokenError.messagePopup = null;
  }
  if (NK.tokenError.pauseTimer) {
    clearTimeout(NK.tokenError.pauseTimer);
    NK.tokenError.pauseTimer = null;
  }
  if (NK.tokenError.pauseCountdownInterval) {
    clearInterval(NK.tokenError.pauseCountdownInterval);
    NK.tokenError.pauseCountdownInterval = null;
  }
};

NK.functions.updateToken = function (request) {
  var i,
    j,
    reloadLimit;

  reloadLimit = new Date(Date.now() - NK.tokenError.RELOAD_LIMIT_SECONDS * 1000);

  NK.gkToken = request.responseText.replace(/[\"\r\n]/g, '');

  if (NK.tokenLastUpdated < reloadLimit) { // was token updated less than RELOAD_LIMIT_SECONDS ago?
    if (!NK.tokenUpdatePaused) {
      NK.functions.resetTokenError();
      NK.tokenLastUpdated = new Date();

      for (i = 0, j = map.layers.length; i < j; i += 1) {
        if (map.layers[i].params && map.layers[i].params.gkt) {
          map.layers[i].params.gkt = NK.gkToken;
          map.layers[i].redraw();
        }
      }
    }
  } else {
    NK.functions.pauseTokenUpdate();
  }
};

NK.functions.pauseTokenUpdate = function () {
  var popup, innerWrapper, heading, message, timeRemaining, statusLink;

  if (!NK.tokenUpdatePaused) {
    NK.tokenUpdatePaused = true;

    //NK.functions.log(OpenLayers.Lang.translate('Server error') +" - "+ OpenLayers.Lang.translate('An error has occured.'));

    NK.tokenError.pauseTimer = setTimeout(function () {
      NK.tokenUpdatePaused = false;
      NK.functions.getNewToken();
    }, 60 * parseInt(NK.tokenError.PAUSE_MINUTES, 10) * 1000);

    NK.tokenError.pauseCountdownInterval = setInterval(function () {
      var content, timeLeft;
      if (NK.tokenError.pauseTimeRemainingElement) {
        content = NK.tokenError.pauseTimeRemainingElement.innerHTML;
        timeLeft = (parseInt(content, 10) - 1);
        NK.tokenError.pauseTimeRemainingElement.innerHTML = timeLeft.toString();
        if (timeLeft === 1) {
          if (NK.tokenError.pauseTimeRemainingText.textContent) {
            NK.tokenError.pauseTimeRemainingText.textContent = ' ' + OpenLayers.Lang.translate('minute.');
          } else {
            // old IE...
            NK.tokenError.pauseTimeRemainingText.innerText = ' ' + OpenLayers.Lang.translate('minute.');
          }
        }
      }
    }, 60 * 1000);
  }
};

NK.functions.getNewToken = function () {
  if (NK.gkToken !== null) {
    NK.gkToken = null;
    OpenLayers.Request.GET({url: NK.tokenService, success: NK.functions.updateToken});
  }
};

NK.functions.getWMSCapabilities = function (url) {
  return NK.functions.corsRequest(url, {"service":"WMS", "request":"GetCapabilities"});
};
NK.functions.getWFSCapabilities = function (url) {
  return NK.functions.corsRequest(url, {"service":"WFS", "request":"GetCapabilities"});
};
NK.functions.getWCSCapabilities = function (url) {
  return NK.functions.corsRequest(url, {"service":"WCS", "request":"GetCapabilities"});
};
NK.functions.corsRequest = function (url, params) {
  if(!!url) {
    if (url.slice(-1) != '?') {url = url+'?';}
    for (var k in params) {
      url += k+"="+params[k]+"&";
    }
    return $.ajax({
      url: '/ws/px.py',
      type: 'GET',
      data: url,
      dataType: 'xml'
    });
  }
}

NK.functions.urlParam = function (name) {
  var results = new RegExp('[#/\\&]'+name+'=(.*?)($|/\\+)').exec(window.location.href);
  return results && results.length && results[1] || 0;
};

NK.functions.addLayerSwitcher = function () {
  var loadingpanel = new OpenLayers.Control.LoadingPanel();
  map.addControl(loadingpanel);
  map.addControl(new OpenLayers.Control.Navigation());
  map.addControl(new OpenLayers.Control.LayerSwitcher({'div': OpenLayers.Util.getElement('layerList'), 
                                                       'filter': {'key':'isUrlDataLayer', 'value':true}}));
};
NK.functions.removeDynamicLayers = function() {
  var dLayers = map.getLayersBy("dynamicLayer",true);
  for (var i=0; i<dLayers.length; i++) {
    map.removeLayer(dLayers[i]);
  }
};

NK.functions.closePopupCallBack = function () {
  var itemIndex;
  for (itemIndex = 0; itemIndex < map.popups.length; itemIndex++) {
    map.popups[itemIndex].hide();
  }
  this.hide();
};

NK.functions.loadWCSLayer = function(wcsUrl, whenDone) {
  NK.dataLayers = NK.dataLayers || {};
  if (!!NK.dataLayers[wcsUrl]) {return;}

  var wcs = {}, formats = {}, layers = {}, title = "", constraints="", attribution="", description="";
  var resultWCS = NK.functions.getWCSCapabilities(wcsUrl);
  resultWCS.error(function (msg) { NK.functions.log(msg.responseText); });
  resultWCS.done(function (xml) {
    
    $(xml).find('formatSupported').each(function() { 
      formats[$(this).text()] = true;
    });
    $(xml).find('CoverageId').each(function() {
      layers[$(this).text()] = true;
    });
    $(xml).find('Title').each(function() {
      title = $(this).text();
    });
    $(xml).find('Abstract').each(function() {
      description = $(this).text();
    });
    $(xml).find('AccessConstraints').each(function() {
      constraints = $(this).text();
    });
    $(xml).find('Attribution').each(function() {
      attribution = $(this).text();
    });
    $(xml).find('ProviderName').each(function() {
      attribution = attribution || $(this).text();
    });
    wcs.formats = Object.keys(formats);
    wcs.layers  = Object.keys(layers);
    wcs.title   = title;
    wcs.constraints = constraints;
    wcs.attribution = attribution;
    whenDone(wcs);
  });
}

NK.functions.addWFSLayer = function(wfsUrl) {
  wfsUrl = wfsUrl.trim();
  if (wfsUrl.slice(-1)=='?') wfsUrl=wfsUrl.slice(0,-1);
  if (map.getLayersBy("url",wfsUrl).length) {return;}
  var layers = [], formats={}, serviceParms={}, layerParms;
  var resultWFS = NK.functions.getWFSCapabilities(wfsUrl);
  resultWFS.error(function (msg) { NK.functions.log(msg.responseText); });
  resultWFS.done(function (xml) {
    var version = $(xml).find('ServiceTypeVersion')
    if (!!version) {
      version = version.last().text().trim(); // TODO: select 1.1.0 over 2.0.0
    }
    serviceParms['version'] = version;
    var exception = $(xml).find('ExceptionText').text();
    if (!!exception) {
      NK.functions.log(exception);
    } else {
      $(xml).find('Service').each(function () {
        serviceParms['serviceTitle'] = $(this).children('Title').text();
        serviceParms['description'] = $(this).children('Abstract').text();
      });
      $(xml).find('ServiceIdentification').each(function () {
        serviceParms['serviceTitle'] = $(this).find('Title').text();
        serviceParms['description'] = $(this).children('Abstract').text();
      });
      $(xml).find('OutputFormats').each(function () {
        $(this).children('Format').each(function () {;
          formats[$(this).text()] = true;
        });
      });
      serviceParms['formats'] = Object.keys(formats);
      $(xml).find('AccessConstraints').each(function () {
        serviceParms['constraints'] = $(this).text();
      });
      var attribution;
      $(xml).find('Attribution').each(function () {
        var href = $(this).children('OnlineResource')[0];
        var logo = $(this).children('LogoURL').children('OnlineResource')[0];
        attribution = { 
          'title': $(this).children('Title').text(),
          'href' : href && href.getAttribute("xlink:href"),
          'logo' : logo && logo.getAttribute("xlink:href")
        }
      });
      if (!attribution) { attribution={'title':OpenLayers.Lang.translate('no attribution'), 'href':'#'}; }
      serviceParms['attribution'] = attribution;
      $(xml).find('FeatureType').each(function () {
        layerParms = {};
        var name = $(this).children('Name').text();
        if (!name) {return;}
        layers.push(name);
        layerParms['title'] = $(this).children('Title').text();
        layerParms['visible'] = (!!NK.visibleLayerQueue[name]) && NK.visibleLayerQueue[name];
        if (name in NK.visibleLayerQueue) {delete NK.visibleLayerQueue[name];}
        if (name in NK.opacityQueue) {delete NK.opacityQueue[name];}
        layerParms['opacity'] = NK.opacityQueue[name] || 1.0;
        layerParms['type'] = name;
        NK.functions.createDynamicWFSLayer(layerParms['title'], wfsUrl, $.extend({},serviceParms, layerParms));
        if (!!NK.xdm) {
          NK.functions.postMessage({"type":"layerLoaded", "title":layerParms['title'], "url":wfsUrl}); 
        }
      });
      NK.functions.updateHistory();
    }
  });

  var geoportal =  map.getControlsByClass('OpenLayers.Control.Geoportal')[0];
  if (!!geoportal) {
    geoportal.showControls(wfsUrl);
    geoportal.displayLayerList();
  }
};

NK.functions.addWMSLayer = function(wmsUrl) {
  wmsUrl = wmsUrl.trim();
  if (wmsUrl.slice(-1)=='?') wmsUrl=wmsUrl.slice(0,-1);
  if (map.getLayersBy("url",wmsUrl).length) {return;}
  var layers = [], formats=[], fiFormats=[], serviceParms={}, layerParms;

  var resultWMS = NK.functions.getWMSCapabilities(wmsUrl);
  resultWMS.error(function (msg) { NK.functions.log(msg.responseText); });
  resultWMS.done(function (xml) {
    serviceParms['version'] = $(xml).children()[0].getAttribute("version");
    $(xml).find('Service').each(function () {
      serviceParms['serviceTitle'] = $(this).children('Title').text();
      serviceParms['description'] = $(this).children('Abstract').text();
    });
    $(xml).find('GetFeatureInfo').each(function () {
      $(this).children('Format').each(function() {
        fiFormats.push($(this).text());
      });
    });
    serviceParms['featureInfoFormats'] = fiFormats;
    $(xml).find('GetMap').each(function () {
      $(this).children('Format').each(function () {;
        formats.push($(this).text());
      });
    });
    serviceParms['formats'] = formats;
    var attribution;
    $(xml).find('Attribution').each(function () {
      var href = $(this).children('OnlineResource')[0];
      var logo = $(this).children('LogoURL').children('OnlineResource')[0];
      attribution = { 
          'title': $(this).children('Title').text(),
          'href' : href && href.getAttribute("xlink:href"),
          'logo' : logo && logo.getAttribute("xlink:href")
      }
    });
    if (!attribution) { attribution={'title':'missing', 'href':'#'}; }
    serviceParms['attribution'] = attribution;
    $(xml).find('AccessConstraints').each(function () {
      serviceParms['constraints'] = $(this).text();
    });
    $(xml).find('Layer').each(function () {
      layerParms={};
      var name = $(this).children('Name').text();
      if (!name) {return;}

      /* if this layer is a child layer, identify parent */
      if ($(this).parent()[0].nodeName=="Layer") {
        layerParms['parent'] = $(this).parent().children('Title').text() || $(this).parent().children('Name').text();
      }

      layerParms['title'] = $(this).children('Title').text();
      layerParms['description'] = $(this).children('Abstract').text();
      layerParms['visible'] = (!!NK.visibleLayerQueue[name]) && NK.visibleLayerQueue[name]; //false or index value
      layerParms['opacity'] = NK.opacityQueue[name] || 1.0;
      var register = (name in NK.visibleLayerQueue) || (name in NK.registeredLayerQueue);
      if (name in NK.opacityQueue) {delete NK.opacityQueue[name];}
      if (name in NK.visibleLayerQueue) {delete NK.visibleLayerQueue[name];}
      if (name in NK.registeredLayerQueue) {delete NK.registeredLayerQueue[name];}
      layers.push(name);
      var bbox = $(xml).find('BoundingBox');
      if (!!bbox) {
        var atts = bbox[0].attributes;
        var srs = atts['CRS'] || atts['SRS'];
        if (srs && (srs.value == map.projection.projCode)) { //TODO: convert from atts["srs"].value to map.projection for anything else
          layerParms['layerBounds'] = new OpenLayers.Bounds(atts["minx"].value, atts["miny"].value,
                                                            atts["maxx"].value, atts["maxy"].value);
        }
      }
      layerParms['layerText']=name;
      if (NK.compactMode && (!register)) {
        var title = layerParms['title'];
        var parms = $.extend({},serviceParms,layerParms);
        NK.registeredLayers[name] = function() { 
          return NK.functions.createDynamicWMSLayer(title, wmsUrl, parms); 
        };
      } else { 
        var layer = NK.functions.createDynamicWMSLayer(layerParms['title'], wmsUrl, $.extend({},serviceParms,layerParms));
        if (register) {
          layer.isStarred = true;
          map.events.triggerEvent("changelayer", {layer:layer, property:"starred"});
        }
      }
      if (!!NK.xdm) {
        NK.functions.postMessage({"type":"layerLoaded", "title":layerParms['title'], "parent":layerParms['parent'],"url":wmsUrl}); 
      }
    });
    NK.functions.updateHistory();
  });

  var geoportal =  map.getControlsByClass('OpenLayers.Control.Geoportal')[0];
  if (!!geoportal) {
    geoportal.showControls(wmsUrl);
    geoportal.displayLayerList();
  }
};

NK.functions.createDynamicWFSLayer = function (name, url, parms) {
  var outputFormat = 'text/xml; subtype=gml/3.2.1';
  if (parms['formats'].indexOf(outputFormat)==-1) outputFormat = 'text/xml; subtype=gml/3.1.1';
  if (parms['formats'].indexOf(outputFormat)==-1) outputFormat = 'text/xml; subtype=gml/2.1.2';
  var wfsLayer = NK.addLayerType.WFS(name, null, url, "", "", parms['type'], {"version":parms['version'], "method":"GET", "styleName":"track", "outputFormat":outputFormat});
  $.extend(wfsLayer,{
    type           : 'wfs',
    isUrlDataLayer : true,
    url            : url,
    initialIndex   : parms['visible'],
    description    : parms['description'],
    serviceTitle   : parms['serviceTitle'],
    dataFormats    : parms['formats'],
    attribution    : parms['attribution'],
    constraints    : parms['constraints']
  });
  wfsLayer.setOpacity(parms['opacity']);
  wfsLayer.setVisibility(!!parms['visible']);

  if (!!parms['visible']) {
    map.setLayerIndex(wfsLayer, parms['visible']-1);
    var layers = map.layers.slice(0);
    for (var i in layers) {
      if (!!layers[i].initialIndex) {
        map.setLayerIndex(wfsLayer, map.getLayerIndex(layers[i])); //replace position
      }
    }
  }

  var type = parms['type'];
  if (type in NK.highlightQueue) {
    var highlights = NK.highlightQueue[type];
    for (var h in highlights) { 
      NK.functions.highlightFeature(wfsLayer, highlights[h][1], highlights[h][2]);
    }
    delete NK.highlightQueue[type];
  }
} 

NK.functions.createDynamicWMSLayer = function (name, url, parms) {
  // TODO: merge with templates/layers/wms.html 
  var wms = new OpenLayers.Layer.WMS(
    name,
    url,
    {
      gkt: NK.gkToken,
      layers: parms['layerText'],
      transparent: true,
      format: 'image/png'
    },
    {
      title: parms['title'],
      serviceTitle: parms['serviceTitle'],
      description: parms['description'],
      parent: parms['parent'] || null,
      isBaseLayer: false,
      buffer: 0,
      ratio: 1.0,
      visibility: !!parms['visible'],
      isStarred: !!parms['visible'], 
      initialIndex: parms['visible'],
      opacity: parms['opacity'] || 1.0,
      transitionEffect: 'resize',
      singleTile: true,
      isUrlDataLayer: true,
      dataFormats: parms['formats'],
      attribution: parms['attribution'],
      constraints: parms['constraints'],
      type: 'wms',
      version: parms['version']
    }
  );
  if (!!parms['layerBounds']) {
    wms.maxExtent = parms['layerBounds'];
    wms.displayOutsideMaxExtent = false;
  }
  if (wms.params.GKT) {
    wms.params.gkt = wms.params.GKT;
    delete wms.params.GKT;
  }
  if (!!parms['featureInfoFormats']) {
    var formats = parms['featureInfoFormats'];
    var preferredFormats = ['application/vnd.ogc.wms_xml', 'text/xml', 'text/plain', 'text/html'];
    var preferredFormat  = 'x';

    while (preferredFormat && formats.indexOf(preferredFormat)==-1) {
      preferredFormat = preferredFormats.shift();
    }

    if (!!preferredFormat) {
      var popupFn = NK.functions.popup.wmsFeatureInfoPopup;
      var featureInfo = new OpenLayers.Control.WMSGetFeatureInfo({
        url: url,
        proxyUrl: "/ws/px.py?"+url,
        title: parms['title'],
        queryVisible: true,
        infoFormat: preferredFormat,
        eventListeners: {
          "getfeatureinfo": function(event) {
            var popup = new OpenLayers.Popup.FramedSideAnchored(null, map.getLonLatFromPixel(event.xy), null, popupFn(event, wms, formats), null, true,
                              NK.functions.closePopupCallBack, {x: 0, y: -15}, 'selected-feature-popup, user-marker')
            map.addPopup(popup, true);
            if (!event.features.length && (!event.text || !event.text.trim().length)) {
              setTimeout(function() {
                map.removePopup(popup);
              }, 3000);
            }
          }
        }
      });
      wms.featureInfoControl = featureInfo;
      wms.events.register('visibilitychanged', wms, function() {
        if(this.getVisibility()) {
          featureInfo.activate();
          if (!!this.maxExtent) {
            var extent = this.maxExtent;
            if (!extent.containsLonLat(map.getCenter())) {
              map.zoomToExtent(extent);
            }
          }
        } else {
          featureInfo.deactivate();
        }
      });
      map.addControl(featureInfo);
      if (!!parms['visible']) {
        featureInfo.activate();
      }
    }
  }
  map.addLayers([wms]);

  if (!!parms['visible']) {
    map.setLayerIndex(wms, parms['visible']-1);
    var layers = map.layers.slice(0);
    for (var i in layers) {
      if (!!layers[i].initialIndex) {
        if (layers[i].initialIndex > wms.initialIndex) { 
          map.setLayerIndex(wms, map.getLayerIndex(layers[i])); //replace position
        }
      }
    }
  }

  NK.functions.createLegend();
  return wms;
};

NK.functions.imgError = function(image, altText) {
  image.style.visibility='hidden';
  image.style.width="10px";
  image.style.height="1px";
  document.getElementById(altText).style.visibility='visible';
};
NK.functions.imgType = function(image, altText) {
  if ((image.mimeType == 'text/xml') || (image.mimeType == 'application/vnd.ogc.se_xml')) { 
    NK.functions.imgError(image, altText);
  }
};

NK.functions.createLegend = function () {
  var legendDiv = OpenLayers.Util.getElement('legendBox');
  if (!!legendDiv) {
    legendDiv.innerHTML = "";
    legendDiv.style.maxHeight = "75vh";
    legendDiv.style.overflowY = "scroll";
    // create getLegendGraphic request for all active layers
    for (var i = 1; i < map.layers.length; i++) {
      var layer = map.layers[i];
      if (layer.visibility && (!!layer.params) && (!!layer.params.LAYERS)) {
        var legendURL = map.layers[i].getFullRequestString({
          REQUEST: "GetLegendGraphic",
          //EXCEPTIONS: "application/vnd.ogc.se_inimage",
          //EXCEPTIONS: "text/xml",
          FORMAT: "image/png",
          SERVICE: "WMS",
          VERSION: "1.1.1",
          LAYER: layer.params.LAYERS
        });
        var name = layer.title || layer.name;
        var id   = "legend_" + layer.name;
        legendDiv.innerHTML += name + "<br/><img src='" + legendURL + "' onerror='NK.functions.imgError(this, \""+id+"\");' onload='NK.functions.imgType(this, \""+id+"\");'>";
        legendDiv.innerHTML += "<span id='"+id+"' style='visibility:hidden'><a href='"+ legendURL +"' style='color:#fff'><i>Feil ved lasting av tegnforklaringen</i></a><br/>";
       
      }
    }
  }
}

% if functions :
  ${functions}
% endif

NK.init = function () {

  var prmstr,
    prmarr,
    params,
    tmparr,
    i,
    j;

  if (!OpenLayers || !Proj4js) {
    setTimeout(NK.init, 100);
    return;
  }

  Proj4js.defs["EPSG:4326"] ="+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";
  Proj4js.defs["EPSG:32629"]="+proj=utm +zone=29 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
  Proj4js.defs["EPSG:32630"]="+proj=utm +zone=30 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
  Proj4js.defs["EPSG:32631"]="+proj=utm +zone=31 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
  Proj4js.defs["EPSG:32632"]="+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
  Proj4js.defs["EPSG:32633"]="+proj=utm +zone=33 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
  Proj4js.defs["EPSG:32634"]="+proj=utm +zone=34 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
  Proj4js.defs["EPSG:32635"]="+proj=utm +zone=35 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
  Proj4js.defs["EPSG:32636"]="+proj=utm +zone=36 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
  Proj4js.defs["EPSG:25831"]="+proj=utm +zone=31 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";
  Proj4js.defs["EPSG:25832"]="+proj=utm +zone=32 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";
  Proj4js.defs["EPSG:25833"]="+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";
  Proj4js.defs["EPSG:25834"]="+proj=utm +zone=34 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";
  Proj4js.defs["EPSG:25835"]="+proj=utm +zone=35 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";
  Proj4js.defs["EPSG:25836"]="+proj=utm +zone=36 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";
  Proj4js.defs["EPSG:3575"] ="+proj=laea +lat_0=90 +lon_0=10 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
  Proj4js.defs["EPSG:3034"] ="+proj=lcc +lat_1=35 +lat_2=65 +lat_0=52 +lon_0=10 +x_0=4000000 +y_0=2800000 +ellps=GRS80 +units=m +no_defs";

  NK.projections = proj = {
    //pregenerated projection objects
    "32633": new OpenLayers.Projection('EPSG:32633'),
    "32629": new OpenLayers.Projection('EPSG:32629'),
    "32630": new OpenLayers.Projection('EPSG:32630'),
    "32631": new OpenLayers.Projection('EPSG:32631'),
    "32632": new OpenLayers.Projection('EPSG:32632'),
    "32634": new OpenLayers.Projection('EPSG:32634'),
    "32635": new OpenLayers.Projection('EPSG:32635'),
    "32636": new OpenLayers.Projection('EPSG:32636'),
    "25831": new OpenLayers.Projection('EPSG:25831'),
    "25832": new OpenLayers.Projection('EPSG:25832'),
    "25833": new OpenLayers.Projection('EPSG:25833'),
    "25834": new OpenLayers.Projection('EPSG:25834'),
    "25835": new OpenLayers.Projection('EPSG:25835'),
    "25836": new OpenLayers.Projection('EPSG:25836'),
    "4326" : new OpenLayers.Projection('EPSG:4326'),
    "3034" : new OpenLayers.Projection('EPSG:3034'),
    "3575" : new OpenLayers.Projection('EPSG:3575')
  };

  NK.boundsFromScale = function(left, top, sd) {
    var TILE = 256 * 0.28 * 0.001;
    var size = TILE * sd;
    return new OpenLayers.Bounds(left, top - size, left + size, top); 
  };

  NK.bounds = bounds = {
    "4326" : NK.boundsFromScale(90, -180, 2.795411320143589E8),
    //"3575" : NK.boundsFromScale(-5545984.0, 5545984.0, 1.5474285714285716E8),
    "3575" : NK.boundsFromScale(-9014250.655, 9014250.655, 2.51513690142E8),
 
    "25829" : NK.boundsFromScale(-500000.0, 9045984.0, 7.737142857142858E7),
    "25830" : NK.boundsFromScale(-1000000.0, 9045984.0, 7.737142857142858E7),
    "25831" : NK.boundsFromScale(-1500000.0, 9045984.0, 7.737142857142858E7),
    "25832" : NK.boundsFromScale(-2000000.0, 9045984.0, 7.737142857142858E7),
    "25833" : NK.boundsFromScale(-2500000.0, 9045984.0, 7.737142857142858E7),
    "25834" : NK.boundsFromScale(-3000000.0, 9045984.0, 7.737142857142858E7),
    "25835" : NK.boundsFromScale(-3500000.0, 9045984.0, 7.737142857142858E7),
    "25836" : NK.boundsFromScale(-4000000.0, 9045984.0, 7.737142857142858E7),

    "32629" : NK.boundsFromScale(-500000.0, 9045984.0, 7.737142857142858E7),
    "32630" : NK.boundsFromScale(-1000000.0, 9045984.0, 7.737142857142858E7),
    "32631" : NK.boundsFromScale(-1500000.0, 9045984.0, 7.737142857142858E7),
    "32632" : NK.boundsFromScale(-2000000.0, 9045984.0, 7.737142857142858E7),
    "32633" : NK.boundsFromScale(-2500000.0, 9045984.0, 7.737142857142858E7),
    "32634" : NK.boundsFromScale(-3000000.0, 9045984.0, 7.737142857142858E7),
    "32635" : NK.boundsFromScale(-3500000.0, 9045984.0, 7.737142857142858E7),
    "32636" : NK.boundsFromScale(-4000000.0, 9045984.0, 7.737142857142858E7)
  }
  
  mapProj   = proj[NK.baseProjection];
  mapBounds = bounds[NK.baseProjection];

  OpenLayers.Util.onImageLoadErrorColor = 'transparent';
  OpenLayers.ImgPath = 'img/';

% if language:
  OpenLayers.Lang.setCode('${language}');
% endif
  if (!!$.localStorage.get('lang')) {
    OpenLayers.Lang.setCode($.localStorage.get('lang'));
  }
  $.localStorage.set('lang', OpenLayers.Lang.getCode());

  // extract URL parameters into dictionary
  prmstr = window.location.search.substr(1);
  prmarr = prmstr.split("&");
  params = {};

  for (i = 0, j = prmarr.length; i < j; i += 1) {
    tmparr = prmarr[i].split("=");
    params[tmparr[0]] = tmparr[1];
  }

  // Create map canvas

  if (!!params.proj) {
    mapProj = proj[params.proj];
  }

  NK.mapOptions = {
    projection: mapProj,
    displayProjection: mapProj,
    maxExtent: mapBounds,
    //units: "m",
    maxResolution: (mapBounds.right - mapBounds.left) / 256, //zoom level 2
    //numZoomLevels: NK.zoomLevels,
    theme: 'theme/norgeskart/style.css'
  };

  map = new OpenLayers.Map(
    'map',
    OpenLayers.Util.extend(NK.mapOptions, {
      controls: [], //defined later
      //numZoomLevels: NK.zoomLevels,
      eventListeners: NK.mapEventListeners,
      paddingForPopups: new OpenLayers.Bounds(85,15,85,75)
    })
  );

% if center:
  // Default placement and zoom of the map
  ${center}
% endif

% if styles:
  // load SLD styles
  ${styles}
% endif

% if baselayers:
  // Base layers
  ${baselayers}
% endif

%if overlays:
  // Overlays
  ${overlays}
% endif

  var removePopups = function () {
    var popup, p;

    for (p in map.popups) {
      if (map.popups.hasOwnProperty(p)) {
        popup = map.popups[p];

        map.removePopup(popup);
      }
    }
  };

  map.events.register('changelayer', map, removePopups);

  // Add controls at the end, to keep focus
  var controlContext = map;
  var container = null;

% if controls:
  ${controls}
% endif


  // initialize URL update state
  if (NK.functions.storeInitialLayerVisibility) {
    NK.functions.storeInitialLayerVisibility();
  }

  var mapPosition = {x: null, y: null};
  if (NK.functions.setMapStateFromURL) {
    mapPosition = NK.functions.setMapStateFromURL();
  }

  // decide which position to use
  if (!(mapPosition.x && mapPosition.y)) {
    map.setCenter(NK.defaultCenter, NK.defaultZoom);

    if (NK.geolocator) {
      NK.geolocator.activate();
    }
  }

  if (NK.functions.postMessage) {
    (function () {
      var vectorLayers,
          layer,
          feature,
          vectorLayerData = [],
          vectorFeatureData = [],
          i, 
          j,
          k,
          l,
          message;

      vectorLayers = map.getLayersByClass("OpenLayers.Layer.Vector").slice();

      for (i = 0, j = vectorLayers.length; i < j; i += 1) {
        layer = vectorLayers[i];
        vectorLayerData.push({shortid: layer.shortid, name: layer.name, visibility: layer.visibility});

        if (layer.visibility && layer.features && layer.features.length) {

          for (k = 0, l = layer.features.length; k < l; k += 1) {
            feature = layer.features[k];
            vectorFeatureData.push({
              "feature": feature.fid,
              "attributes": feature.attributes
            });
          }

        }
      }

      message = {
        "type": "mapInitialized",
        "vectorLayers": vectorLayerData
      };

      if (vectorFeatureData.length > 0) {
        message.visibleLayerFeatures = vectorFeatureData;
      }

      NK.functions.postMessage(message);
    }());

  }
};
// end init()


var addEvent = function (event, handler) {
  var listen = window.addEventListener || window.attachEvent;
  if (window.addEventListener) {
    listen(event, handler, false);
  } else {
    listen("on" + event, handler);
  }
};

var cb = function (response, status, request) {
  NK.gkToken = request.responseText.replace(/[\"\r\n]/g, '');
  NK.init();
};

var initializeToken = function () {
  $.ajax({
    url: NK.tokenService,
    success: cb,
    type: 'GET'
  });
};
addEvent('load', initializeToken);
