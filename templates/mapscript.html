<script type="text/javascript">
   var gkopen="http://opencache.statkart.no/gatekeeper/gk/gk.open";
   OpenLayers.Util.onImageLoadErrorColor = 'transparent';

   var mapProj = new OpenLayers.Projection('EPSG:32633');
   var mapBounds = new OpenLayers.Bounds(-2500000.0,3500000.0,3045984.0,9045984.0); 

   Proj4js.defs["EPSG:32632"]="+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";

   var xdmsocket = new easyXDM.Socket({});

   function init(){
// Create map canvas

      var map;        
      var initLayers;

      var updateHistory = function(evt){
        if (!!map) {
          var center = map.getCenter();
          var zoom   = map.getZoom();
          if (!!center && !!zoom) {
            uid = zoom+"/"+center.lon+"/"+center.lat;
            if (map.layers != initLayers) { 
              /* todo: detect any changes to the original layer configuration 
                       and add a modifier to the location.hash
                 +layer = layer visible (or base layer selected)
                 -layer = layer invisible
              */
            }
            window.location.hash = uid;
          }
        }
      };

      map = new OpenLayers.Map( 'map', {
      	 //controls: [new OpenLayers.Control.PanZoomBar()],
      	 projection: mapProj,
      	 maxExtent:  mapBounds,
      	 units: "m",
      	 maxResolution: 21664.0,
      	 numZoomLevels: 18,

         eventListeners: {
           "moveend": updateHistory,
           "zoomend": updateHistory,
           "changelayer": updateHistory,
           "changebaselayer": updateHistory
         }
      } );
      var layer_sw = new OpenLayers.Control.LayerSwitcher();
      map.addControl(layer_sw);
      layer_sw.maximizeControl();
      
// Base layers
      ${baselayers}
// Placement and zoom of the map
      ${center}
// Overlays
      ${overlays}
// Add controls at the end, to keep focus
      ${controls}

// store the initial layer configuration
      initLayers = map.layers;
   }
</script>
