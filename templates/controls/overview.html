<%inherit file="/controls/controlcontext.html" />

<%include file="/functions/vector.html" />
<%include file="/styles/omriss.html" />

(function (M, MP, P) {
  var layer,
      requestHandler,
      control;

  var norgeExtent = new OpenLayers.Bounds(-76856, 6453900, 1114892, 7939873);

  layer = new OpenLayers.Layer.Vector(
    "${name}",
    {
      shortid: "${id}", 
      styleMap: NK.styles.omriss, 
      visibility: true
    }
  );

  requestHandler = function (request) {
    var geojson_format,
        features;

    geojson_format = new OpenLayers.Format.GeoJSON({
      'internalProjection': MP,
      'externalProjection': P['32633'] 
    });


    features = geojson_format.read(request.responseText);

    layer.addFeatures(features);

  	options.maximized = true;
  	options.maximizeTitle = 'Show the overview map';
  	options.minimizeTitle = 'Hide the overview map';
    options.minRatio = 16;
    options.maxRatio = 64;
    options.size = {w: 80, h: 90};

    options.mapOptions = OpenLayers.Util.extend(NK.mapOptions, {
      numZoomLevels: NK.zoomLevels,
      maxExtent: norgeExtent,
      restrictedExtent: norgeExtent,
      maxResolution: 18000.0,
      controls: [],
      baseLayer: layer
    });
  	options.autoPan = true;
  	options.layers = [layer];

    control = new (OpenLayers.Class(OpenLayers.Control.OverviewMap, {
      resize: function (width, height) {
        var extent;

        this.size.w = width;
        this.size.h = height;
        this.mapDiv.style.width = this.size.w + 'px';
        this.mapDiv.style.height = this.size.h + 'px';

        extent = this.ovmap.getExtent();
        this.ovmap.updateSize();

        this.ovmap.zoomToExtent(extent);

        if (this.ovmap.getProjection() != this.map.getProjection()) {
            var sourceUnits = this.map.getProjectionObject().getUnits() ||
                this.map.units || this.map.baseLayer.units;
            var targetUnits = this.ovmap.getProjectionObject().getUnits() ||
                this.ovmap.units || this.ovmap.baseLayer.units;
            this.resolutionFactor = sourceUnits && targetUnits ?
                OpenLayers.INCHES_PER_UNIT[sourceUnits] /
                OpenLayers.INCHES_PER_UNIT[targetUnits] : 1;
        }
        console.log('neio her');

        this.updateRectToMap();
        this.update();
        
      }
    }))(options);

  	NK.functions.addControlToContext(control, context);

  };

  OpenLayers.Request.GET({
    url: "${url}",
    callback: requestHandler
  });

}(map, mapProj, proj));

