/*! SOSI.js 09-10-2013 */
var SOSI=window.SOSI||{};!function(a){"use strict";a.Base=function(){this.initialize.apply(this,arguments)},_.extend(a.Base.prototype,{initialize:function(){}}),a.Base.extend=function(a,b){var c,d=this;c=a&&_.has(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},_.extend(c,d,b);var e=function(){this.constructor=c};return e.prototype=d.prototype,c.prototype=new e,a&&_.extend(c.prototype,a),c.__super__=d.prototype,c}}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";a.util={cleanupLine:function(a){return-1!==a.indexOf("!")&&(a=a.substring(0,a.indexOf("!"))),a.replace(/\s\s*$/,"")},countStartingDots:function(a){var b=!1;return _.reduce(a,function(a,c){return"."!==c||b?b=!0:a+=1,a},0)},parseQuality:function(a){if(!a)return null;var b=["maalemetode","noyaktighet","synbarhet","h-maalemetode","h-noyaktighet","max-avvik"];if(_.isString(a))return _.reduce(a.split(" "),function(a,c,d){return a[b[d]]=parseInt(c,10),a},{});throw new Error("Reading KVALITET as subfields not implemented!")},round:function(a,b){var c=Math.pow(10,b);return Math.round(a*c)/c}},a.koordsysMap={1:{srid:"EPSG:27391",def:"+proj=tmerc +lat_0=58 +lon_0=-4.666666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},2:{srid:"EPSG:27392",def:"+proj=tmerc +lat_0=58 +lon_0=-2.333333333333333 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},3:{srid:"EPSG:27393",def:"+proj=tmerc +lat_0=58 +lon_0=0 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},4:{srid:"EPSG:27394",def:"+proj=tmerc +lat_0=58 +lon_0=2.5 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},5:{srid:"EPSG:27395",def:"+proj=tmerc +lat_0=58 +lon_0=6.166666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},6:{srid:"EPSG:27396",def:"+proj=tmerc +lat_0=58 +lon_0=10.16666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},7:{srid:"EPSG:27397",def:"+proj=tmerc +lat_0=58 +lon_0=14.16666666666667 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},8:{srid:"EPSG:27398",def:"+proj=tmerc +lat_0=58 +lon_0=18.33333333333333 +k=1 +x_0=0 +y_0=0 +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +pm=oslo +units=m +no_defs"},9:{srid:"EPSG:4273",def:"+proj=longlat +a=6377492.018 +b=6356173.508712696 +towgs84=278.3,93,474.5,7.889,0.05,-6.61,6.21 +no_defs"},21:{srid:"EPSG:32631",def:"+proj=utm +zone=31 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},22:{srid:"EPSG:32632",def:"+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},23:{srid:"EPSG:32633",def:"+proj=utm +zone=33 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},24:{srid:"EPSG:32634",def:"+proj=utm +zone=34 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},25:{srid:"EPSG:32635",def:"+proj=utm +zone=35 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},26:{srid:"EPSG:32636",def:"+proj=utm +zone=35 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"},31:{srid:"EPSG:23031",def:"+proj=utm +zone=31 +ellps=intl +units=m +no_defs"},32:{srid:"EPSG:23032",def:"+proj=utm +zone=32 +ellps=intl +units=m +no_defs"},33:{srid:"EPSG:23033",def:"+proj=utm +zone=33 +ellps=intl +units=m +no_defs"},34:{srid:"EPSG:23034",def:"+proj=utm +zone=34 +ellps=intl +units=m +no_defs"},35:{srid:"EPSG:23035",def:"+proj=utm +zone=35 +ellps=intl +units=m +no_defs"},36:{srid:"EPSG:23036",def:"+proj=utm +zone=36 +ellps=intl +units=m +no_defs"},50:{srid:"EPSG:4230",def:"+proj=longlat +ellps=intl +no_defs"},72:{srid:"EPSG:4322",def:"+proj=longlat +ellps=WGS72 +no_defs "},84:{srid:"EPSG:4326",def:"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs "},87:{srid:"EPSG:4231",def:"+proj=longlat +ellps=intl +no_defs "}},Proj4js&&_.each(a.koordsysMap,function(a){Proj4js.defs[a.srid]=a.def})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(a){var b=a.split(" "),c={};return c[b.shift()]=b.join(" "),c}function c(a,b){var c=a[b]||"";return c.replace(/"/g,"")}function d(a,b){return parseFloat(a[b])}function e(b){if(b=parseInt(b,10),a.koordsysMap[b])return a.koordsysMap[b].srid;throw new Error("KOORDSYS = "+b+" not found!")}function f(a){var b=a["MIN-NØ"].split(" "),c=a["MAX-NØ"].split(" ");return[parseFloat(b[1]),parseFloat(b[0]),parseFloat(c[1]),parseFloat(c[0])]}function g(a){return a=_.filter(a.split(" "),function(a){return""!==a}),{x:parseFloat(a[1]),y:parseFloat(a[0])}}a.Head=a.Base.extend({initialize:function(a){this.setData(a)},parse:function(c){var d,e=_.reduce(c,function(c,e){return e=a.util.cleanupLine(e),2===a.util.countStartingDots(e)?(e=e.replace("..",""),1===e.split(" ").length?(c[e]=[],d=e):_.extend(c,b(e))):c[d].push(e),c},{});return _.reduce(e,function(a,c,d){return a[d]=_.isArray(c)?_.reduce(c,function(a,c){return _.extend(a,b(c.replace("...","")))},{}):c,a},{})},setData:function(b){b=this.parse(b),this.eier=c(b,"EIER"),this.produsent=c(b,"PRODUSENT"),this.objektkatalog=c(b,"OBJEKTKATALOG"),this.verifiseringsdato=c(b,"VERIFISERINGSDATO"),this.version=d(b,"SOSI-VERSJON"),this.level=d(b,"SOSI-NIVÅ"),this.kvalitet=a.util.parseQuality(b.KVALITET),this.bbox=f(b.OMRÅDE),this.origo=g(b.TRANSPAR["ORIGO-NØ"]),this.enhet=parseFloat(b.TRANSPAR.ENHET),this.vertdatum=c(b.TRANSPAR,"VERT-DATUM"),this.srid=e(b.TRANSPAR.KOORDSYS)}})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(a,b){var c=_.flatten(_.map(a,function(a){var c=Math.abs(a),d=b.getById(c);if(!d)throw new Error("Fant ikke KURVE "+c+" for FLATE");var e=d.geometry.kurve;return 0>a&&(e=_.clone(e).reverse()),_.initial(e)}));return c.push(c[0]),c}function c(a){return _.map(a.trim().split(" "),function(a){return parseInt(a.replace(":",""),10)})}a.Point=a.Base.extend({knutepunkt:!1,initialize:function(b,c,d){_.isArray(b)&&(b=b[1]);var e=b.split(" "),f=0;1>d&&(f=String(d).split(".")[1].length),this.y=a.util.round(parseInt(e[0],10)*d+c.y,f),this.x=a.util.round(parseInt(e[1],10)*d+c.x,f),e[2]&&!isNaN(e[2])&&(this.z=a.util.round(parseInt(e[2],10)*d,f)),-1!==b.indexOf(".KP")&&this.setTiepoint(b.substring(b.indexOf(".KP"),b.length).split(" ")[1])},setTiepoint:function(a){this.has_tiepoint=!0,this.knutepunktkode=parseInt(a,10)}}),a.LineString=a.Base.extend({initialize:function(b,c,d){this.kurve=_.compact(_.map(b,function(b){return-1===b.indexOf("NØ")?new a.Point(b,c,d):void 0})),this.knutepunkter=_.filter(this.kurve,function(a){return a.has_tiepoint})}}),a.Polygon=a.Base.extend({initialize:function(a,d){var e=a,f=[],g=a.indexOf("(");-1!==g&&(e=a.substr(0,g),f=a.substr(g,a.length)),e=c(e),f=_.map(_.reduce(f,function(a,b){return"("===b?a.push(""):")"!==b&&""!==b&&(a[a.length-1]+=b),a},[]),c),this.flate=b(e,d),this.holes=_.map(f,function(a){if(1===a.length){var c=d.getById(Math.abs(a[0]));if("FLATE"===c.geometryType)return c.geometry.flate}return b(a,d)}),this.shellRefs=e,this.holeRefs=f}})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(b,c,d,e){var f={PUNKT:a.Point,KURVE:a.LineString,FLATE:a.Polygon};if(!f[b])throw new Error("GeometryType "+b+" is not handled (yet..?)");return new f[b](c,d,e)}var c={KVALITET:{name:"kvalitet",createFunction:a.util.parseQuality}};a.Feature=a.Base.extend({initialize:function(a,b,c,d){if(!a.id)throw new Error("Feature must have ID!");this.id=a.id,this.parseData(a,b,c,d),this.geometryType=a.geometryType},parseData:function(b,d,e){var f=!1,g=_.reduce(b.lines,function(b,c){return c=a.util.cleanupLine(c),-1!==c.indexOf("..NØ")&&(f=!0),f?b.geometry.push(c.replace("..","")):0!==c.indexOf("..")?b.attributes[b.attributes.length-1]+=" "+c:b.attributes.push(c.replace("..","")),b},{attributes:[],geometry:[]});this.attributes=_.reduce(g.attributes,function(a,b){b=b.split(" ");var d=b.shift();return c[d]?a[c[d].name]=c[d].createFunction(b.join(" ")):a[d]=b.join(" "),a},{}),this.raw_data={geometryType:b.geometryType,geometry:g.geometry,origo:d,unit:e}},buildGeometry:function(c){"FLATE"===this.raw_data.geometryType?(this.geometry=new a.Polygon(this.attributes.REF,c),this.geometry.center=new a.Point(this.raw_data.geometry,this.raw_data.origo,this.raw_data.unit),this.attributes=_.omit(this.attributes,"REF")):this.geometry=b(this.raw_data.geometryType,this.raw_data.geometry,this.raw_data.origo,this.raw_data.unit),this.raw_data=null}}),a.Features=a.Base.extend({initialize:function(b,c){this.head=c,this.features=[],this.features=_.map(b,function(b,d){d=d.replace(":","").split(" ");var e={id:parseInt(d[1],10),geometryType:d[0],lines:b};return new a.Feature(e,c.origo,c.enhet)},this)},ensureGeom:function(a){return a.geometry||a.buildGeometry(this),a},length:function(){return this.features.length},at:function(a){return this.ensureGeom(this.features[a])},getById:function(a){return this.ensureGeom(_.find(this.features,function(b){return b.id===a}))},all:function(){return _.map(this.features,this.ensureGeom,this)}})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(a){return[a.x,a.y]}function c(a,b){return _.map(a,function(a){var c=b[Math.abs(a)].index;return a>0?c:-(Math.abs(c)+1)})}a.Sosi2GeoJSON=a.Base.extend({initialize:function(a){this.sosidata=a},dumps:function(){return{type:"FeatureCollection",features:this.getFeatures(),crs:this.writeCrs()}},getFeatures:function(){return _.map(this.sosidata.features.all(),this.createGeoJsonFeature,this)},createGeoJsonFeature:function(a){return{type:"Feature",id:a.id,properties:a.attributes,geometry:this.writeGeometry(a.geometry)}},writeGeometry:function(c){if(c instanceof a.Point)return{type:"Point",coordinates:b(c)};if(c instanceof a.LineString)return{type:"LineString",coordinates:_.map(c.kurve,b)};if(c instanceof a.Polygon){var d=_.map(c.flate,b),e=_.map(c.holes,function(a){return _.map(a,b)});return{type:"Polygon",coordinates:[d].concat(e)}}throw new Error("cannot write geometry!")},writeCrs:function(){return{type:"name",properties:{name:this.sosidata.hode.srid}}}}),a.Sosi2TopoJSON=a.Base.extend({initialize:function(a){this.sosidata=a},dumps:function(a){var b=this.getPoints(),c=this.getLines(),d=this.getPolygons(c),e=b.concat(_.map(c,function(a){return a.geometry})).concat(d),f={type:"Topology",objects:{}};f.objects[a]={type:"GeometryCollection",geometries:e};var g=_.map(_.sortBy(c,function(a){return a.index}),function(a){return a.arc});return g.length&&(f.arcs=g),f},getByType:function(a){return _.filter(this.sosidata.features.all(),function(b){return b.geometry instanceof a})},getPoints:function(){var c=this.getByType(a.Point);return _.map(c,function(a){var c=_.clone(a.attributes);return c.id=a.id,{type:"Point",properties:c,coordinates:b(a.geometry)}})},getLines:function(){var c=this.getByType(a.LineString);return _.reduce(c,function(a,c,d){var e=_.clone(c.attributes);return e.id=c.id,a[c.id]={geometry:{type:"LineString",properties:e,arcs:[d]},arc:_.map(c.geometry.kurve,b),index:d},a},{})},getPolygons:function(b){var d=this.getByType(a.Polygon);return _.map(d,function(d){var e=_.clone(d.attributes);e.id=d.id;var f=[c(d.geometry.shellRefs,b)];return f=f.concat(_.map(d.geometry.holeRefs,function(d){if(1===d.length){var e=this.sosidata.features.getById(d[0]);if(e.geometry instanceof a.Polygon)return c(e.geometry.shellRefs,b)}return c(d,b)},this)),{type:"Polygon",properties:e,arcs:f}},this)}})}(SOSI);var SOSI=window.SOSI||{};!function(a){"use strict";function b(b){return 1===a.util.countStartingDots(b)}function c(a){return!(a[0]&&"!"!==a[0])}var d=a.Base.extend({}),e=a.Base.extend({}),f={geojson:a.Sosi2GeoJSON,topojson:a.Sosi2TopoJSON},g=a.Base.extend({initialize:function(b){this.hode=new a.Head(b.HODE),this.def=new d(b.DEF),this.objdef=new e(b.OBJDEF),this.features=new a.Features(_.omit(b,["HODE","DEF","OBJDEF","SLUTT"]),this.hode)},dumps:function(a){if(f[a])return new f[a](this).dumps(_.rest(arguments));throw new Error("Outputformat "+a+" is not supported!")}});a.Parser=a.Base.extend({parse:function(d){var e,f=_.reduce(d.split("\n"),function(d,f){if(!c(f))if(b(f)){var g=a.util.cleanupLine(f.replace(".",""));d[g]=[],e=g}else e&&d[e].push(f);return d},{});return new g(f)}})}(SOSI);